
/******************************************************************************
*
*   FILE
*   ----
*   openAASDiscoveryServerHTTPExt.c
*
*   History
*   -------
*   2018-09-12   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_openAASDiscoveryServerHTTP
#define OV_COMPILE_LIBRARY_openAASDiscoveryServerHTTP
#endif


#include "openAASDiscoveryServerHTTP.h"
#include "libov/ov_macros.h"
#include "ks_logfile.h"
#include "libov/ov_result.h"
#include "libov/ov_path.h"
#include "json_helper.h"


OV_DLLFNCEXPORT OV_RESULT openAASDiscoveryServerHTTP_openAASDiscoveryServerHTTPExt_constructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_openAASDiscoveryServerHTTP_openAASDiscoveryServerHTTPExt pinst = Ov_StaticPtrCast(openAASDiscoveryServerHTTP_openAASDiscoveryServerHTTPExt, pobj);
    OV_RESULT    result;

    /* do what the base class does first */
    result = ksbase_ComTask_constructor(pobj);
    if(Ov_Fail(result))
         return result;

    /* do what */
    result = Ov_SetDynamicVectorLength(&pinst->v_commandList, 4, STRING);
	if(Ov_Fail(result))
		return result;
	result = ov_string_setvalue(&pinst->v_commandList.value[0], "*/securityCheck");
	if(Ov_Fail(result))
		return result;
	result = ov_string_setvalue(&pinst->v_commandList.value[1], "*/registerAAS");
	if(Ov_Fail(result))
		return result;
	result = ov_string_setvalue(&pinst->v_commandList.value[2], "*/unregisterAAS");
	if(Ov_Fail(result))
		return result;
	result = ov_string_setvalue(&pinst->v_commandList.value[3], "*/searchForAAS");
	if(Ov_Fail(result))
		return result;

    return OV_ERR_OK;
}

OV_RESULT getDiscoveryServer(OV_INSTPTR_openAASDiscoveryServer_DiscoveryServer *pDiscoveryServer, OV_STRING url, OV_STRING **pList, OV_UINT *len, OV_UINT *count){
	OV_STRING ressourcePath = NULL;
	*pList = ov_string_split(url, "/", len);
	for (*count = 0; *count < (*len)-1; (*count)++){
		if (*count == 0){
			ov_string_setvalue(&ressourcePath, (*pList)[*count]);
			continue;
		}
		ov_string_append(&ressourcePath, "/");
		ov_string_append(&ressourcePath, (*pList)[*count]);
	}

	*pDiscoveryServer = Ov_DynamicPtrCast(openAASDiscoveryServer_DiscoveryServer, ov_path_getobjectpointer(ressourcePath, 2));
	ov_string_setvalue(&ressourcePath, NULL);
	if (!*pDiscoveryServer){
		KS_logfile_info(("could not find discoveryServer object"));
		ov_string_freelist(*pList);
		return OV_ERR_BADPARAM;
	}

	return OV_ERR_OK;
}

OV_DLLFNCEXPORT OV_BOOL openAASDiscoveryServerHTTP_openAASDiscoveryServerHTTPExt_CheckCommand(
	const OV_INSTPTR_kshttp_httpClientHandlerExtension	pobj,
	const OV_INSTPTR_kshttp_httpclienthandler	pClientHandler,
	const OV_INSTPTR_ksbase_Channel pChannel,
	const HTTP_REQUEST request
) {
    /*
    *   local variables
    */
	OV_UINT len = 0;
	OV_STRING* pList = NULL;
	OV_UINT count = 0;
	OV_INSTPTR_openAASDiscoveryServerHTTP_openAASDiscoveryServerHTTPExt pExt = NULL;
	pExt = Ov_StaticPtrCast(openAASDiscoveryServerHTTP_openAASDiscoveryServerHTTPExt, pobj);
	pExt->v_pInterfaceDiscoveryServer = NULL;
	pExt->v_pDiscoveryServer = NULL;
	pExt->v_queryType = 0;
	// check if InterfaceDiscoverServer exist
	pExt->v_pInterfaceDiscoveryServer = Ov_StaticPtrCast(openaas_InterfaceDiscoveryServer, Ov_GetFirstChild(ov_instantiation, pclass_openaas_InterfaceDiscoveryServer));
	if(!pExt->v_pInterfaceDiscoveryServer){
		return FALSE;
	}

	// get DiscoveryServer
	if (getDiscoveryServer(&pExt->v_pDiscoveryServer, request.urlPath, &pList, &len, &count) != OV_ERR_OK){
		return FALSE;
	}

	if (ov_string_compare(pList[count], "securityCheck") == OV_STRCMP_EQUAL){
		pExt->v_queryType = 0;
	}else if (ov_string_compare(pList[count], "registerAAS") == OV_STRCMP_EQUAL){
		pExt->v_queryType = 1;
	}else if (ov_string_compare(pList[count], "unregisterAAS") == OV_STRCMP_EQUAL){
		pExt->v_queryType = 2;
	}else if (ov_string_compare(pList[count], "searchForAAS") == OV_STRCMP_EQUAL){
		pExt->v_queryType = 3;
	}else if (ov_string_compare(pList[count], "getCarrierIDList") == OV_STRCMP_EQUAL){
		pExt->v_queryType = 4;
	}else if (ov_string_compare(pList[count], "getPropertyIDList") == OV_STRCMP_EQUAL){
		pExt->v_queryType = 5;
	}else if (ov_string_compare(pList[count], "getExpressionSemanticList") == OV_STRCMP_EQUAL){
		pExt->v_queryType = 6;
	}else if (ov_string_compare(pList[count], "getRelationList") == OV_STRCMP_EQUAL){
		pExt->v_queryType = 7;
	}else if (ov_string_compare(pList[count], "getSubModelList") == OV_STRCMP_EQUAL){
		pExt->v_queryType = 8;
	}else{
		return FALSE;
	}
	ov_string_freelist(pList);

    return TRUE;
}

OV_DLLFNCEXPORT OV_RESULT openAASDiscoveryServerHTTP_openAASDiscoveryServerHTTPExt_HandleExtendedRequest(
	const OV_INSTPTR_kshttp_httpClientHandlerExtension	pobj,
	const OV_INSTPTR_kshttp_httpclienthandler	pClientHandler,
	const OV_INSTPTR_ksbase_Channel pChannel,
	const HTTP_REQUEST request,
	HTTP_RESPONSE *response
) {
    /*    
    *   local variables
    */
	OV_STRING JsonOutput = NULL;
	OV_STRING errorMessage = NULL;
	OV_VTBLPTR_openAASDiscoveryServer_Registration pvtableRegistration = NULL;
	OV_VTBLPTR_openAASDiscoveryServer_Security pvtableSecurity = NULL;
	OV_VTBLPTR_openAASDiscoveryServer_Search pvtableSearch = NULL;
	OV_INSTPTR_openAASDiscoveryServerHTTP_openAASDiscoveryServerHTTPExt pExt = NULL;
	pExt = Ov_StaticPtrCast(openAASDiscoveryServerHTTP_openAASDiscoveryServerHTTPExt, pobj);
	json_data jsonData;
	json_data_init(&jsonData);

	if (pExt->v_queryType < 4){
		if(request.urlQuery.veclen != 2){
			KS_logfile_info(("wrong data size in content", request.requestMethod));
			ov_string_setvalue(&response->contentString, "wrong data size\n");
			return OV_ERR_BADVALUE;
		}
		if (ov_string_compare(request.urlQuery.value[0], "data") != OV_STRCMP_EQUAL){
			KS_logfile_info(("wrong key in content", request.requestMethod));
			ov_string_setvalue(&response->contentString, "wrong key\n");
			return OV_ERR_BADVALUE;
		}

		ov_string_setvalue(&jsonData.js, "\"body\":");
		ov_string_append(&jsonData.js, request.urlQuery.value[1]);

		if(jsonTokenize(&jsonData) != OV_ERR_OK) {
			KS_logfile_info(("value not in correct json format", request.requestMethod));
			ov_string_setvalue(&response->contentString, "value not in correct json format\n");
			return OV_ERR_BADVALUE;
		}
	}

	switch(pExt->v_queryType){
		case 0: // securityCheck
			Ov_GetVTablePtr(openAASDiscoveryServer_Security, pvtableSecurity, &pExt->v_pDiscoveryServer->p_Security);
			if (pvtableSecurity){
				if (pvtableSecurity->m_getSecurityMessage(Ov_DynamicPtrCast(openAASDiscoveryServer_Part, &pExt->v_pDiscoveryServer->p_Security), jsonData, &JsonOutput, &errorMessage) != OV_ERR_OK){
					ov_string_setvalue(&JsonOutput, NULL);
					KS_logfile_info(("Error in part-function: %s", errorMessage));
					ov_string_setvalue(&response->contentString, errorMessage);
					ov_string_setvalue(&errorMessage, NULL);
					json_data_deleteMembers(&jsonData);
					return OV_ERR_OK;
				}
			}else{
				json_data_deleteMembers(&jsonData);
				KS_logfile_info(("Could not get VTable Pointer of Security-Object", request.requestMethod));
				ov_string_setvalue(&response->contentString, "Internal Error\n");
				return OV_ERR_OK;
			}
		break;
		case 1: // registerAAS
			Ov_GetVTablePtr(openAASDiscoveryServer_Registration, pvtableRegistration, &pExt->v_pDiscoveryServer->p_Registration);
			if (pvtableRegistration){
				if (pvtableRegistration->m_getRegistrationMessage(Ov_DynamicPtrCast(openAASDiscoveryServer_Part, &pExt->v_pDiscoveryServer->p_Registration), jsonData, &JsonOutput, &errorMessage) != OV_ERR_OK){
					ov_string_setvalue(&JsonOutput, NULL);
					KS_logfile_info(("Error in part-function: %s", errorMessage));
					ov_string_setvalue(&response->contentString, errorMessage);
					ov_string_setvalue(&errorMessage, NULL);
					json_data_deleteMembers(&jsonData);
					return OV_ERR_OK;
				}
			}else{
				json_data_deleteMembers(&jsonData);
				KS_logfile_info(("Could not get VTable Pointer of Registration-Object", request.requestMethod));
				ov_string_setvalue(&response->contentString, "Internal Error\n");
				return OV_ERR_OK;
			}
		break;
		case 2: // unregisterAAS
			Ov_GetVTablePtr(openAASDiscoveryServer_Registration, pvtableRegistration, &pExt->v_pDiscoveryServer->p_Registration);
			if (pvtableRegistration){
				if (pvtableRegistration->m_getUnregistrationMessage(Ov_DynamicPtrCast(openAASDiscoveryServer_Part, &pExt->v_pDiscoveryServer->p_Registration), jsonData, &JsonOutput, &errorMessage) != OV_ERR_OK){
					ov_string_setvalue(&JsonOutput, NULL);
					KS_logfile_info(("Error in part-function: %s", errorMessage));
					ov_string_setvalue(&response->contentString, errorMessage);
					ov_string_setvalue(&errorMessage, NULL);
					json_data_deleteMembers(&jsonData);
					return OV_ERR_OK;
				}
			}else{
				json_data_deleteMembers(&jsonData);
				KS_logfile_info(("Could not get VTable Pointer of Registration-Object", request.requestMethod));
				ov_string_setvalue(&response->contentString, "Internal Error\n");
				return OV_ERR_OK;
			}
		break;
		case 3: // searchForAAS
			Ov_GetVTablePtr(openAASDiscoveryServer_Search, pvtableSearch, &pExt->v_pDiscoveryServer->p_Search);
			if (pvtableSearch){
				if (pvtableSearch->m_getSearchMessage(Ov_DynamicPtrCast(openAASDiscoveryServer_Part, &pExt->v_pDiscoveryServer->p_Search), jsonData, &JsonOutput, &errorMessage) != OV_ERR_OK){
					ov_string_setvalue(&JsonOutput, NULL);
					KS_logfile_info(("Error in part-function: %s", errorMessage));
					ov_string_setvalue(&response->contentString, errorMessage);
					ov_string_setvalue(&errorMessage, NULL);
					json_data_deleteMembers(&jsonData);
					return OV_ERR_OK;
				}
			}else{
				json_data_deleteMembers(&jsonData);
				KS_logfile_info(("Could not get VTable Pointer of Search-Object", request.requestMethod));
				ov_string_setvalue(&response->contentString, "Internal Error\n");
				return OV_ERR_OK;
			}
		break;
		case 4: // getCarrierIDList
			{
			OV_INSTPTR_openAASDiscoveryServer_DBWrapper pDBWrapper = NULL;
			OV_VTBLPTR_openAASDiscoveryServer_DBWrapper pDBWrapperVTable = NULL;
			OV_STRING_VEC result;
			result.value = NULL;
			result.veclen = 0;
			OV_STRING tmpFields = "Value";
			OV_STRING table = "CarrierID";
			if (pExt->v_pDiscoveryServer->p_Registration.v_DBWrapper.veclen > 0){
				pDBWrapper = Ov_DynamicPtrCast(openAASDiscoveryServer_DBWrapper, ov_path_getobjectpointer(pExt->v_pDiscoveryServer->p_Registration.v_DBWrapper.value[0], 2));
				if (!pDBWrapper){
					KS_logfile_info(("Could not get database Pointer"));
					ov_string_setvalue(&response->contentString, "Internal Error\n");
					return OV_ERR_OK;
				}
				Ov_GetVTablePtr(openAASDiscoveryServer_DBWrapper,pDBWrapperVTable, pDBWrapper);
				pDBWrapperVTable->m_selectData(pDBWrapper, table, &tmpFields, 1, NULL, 0, NULL, 0, &result);
			}
			ov_string_setvalue(&response->contentString, "{\"CarrierIDList\":[");
			for (OV_UINT i = 0; i < result.veclen; i++){
				if (i != 0){
					ov_string_append(&response->contentString, ",");
				}
				ov_string_append(&response->contentString, "\"");
				ov_string_append(&response->contentString, result.value[i]);
				ov_string_append(&response->contentString, "\"");
			}
			ov_string_append(&response->contentString, "]}");
			Ov_SetDynamicVectorLength(&result, 0, STRING);
			ov_string_setvalue(&response->contentType, "application/json; charset=utf-8");
			return OV_ERR_OK;
			}
		break;
		case 5: // getPropertyIDList
			{
			OV_INSTPTR_openAASDiscoveryServer_DBWrapper pDBWrapper = NULL;
			OV_VTBLPTR_openAASDiscoveryServer_DBWrapper pDBWrapperVTable = NULL;
			OV_STRING tmpFields = "Value";
			OV_STRING_VEC result;
			result.value = NULL;
			result.veclen = 0;
			OV_STRING table = "PropertyID";
			if (pExt->v_pDiscoveryServer->p_Registration.v_DBWrapper.veclen > 0){
				pDBWrapper = Ov_DynamicPtrCast(openAASDiscoveryServer_DBWrapper, ov_path_getobjectpointer(pExt->v_pDiscoveryServer->p_Registration.v_DBWrapper.value[0], 2));
				if (!pDBWrapper){
					KS_logfile_info(("Could not get database Pointer"));
					ov_string_setvalue(&response->contentString, "Internal Error\n");
					return OV_ERR_OK;
				}
				Ov_GetVTablePtr(openAASDiscoveryServer_DBWrapper,pDBWrapperVTable, pDBWrapper);
				pDBWrapperVTable->m_selectData(pDBWrapper, table, &tmpFields, 1, NULL, 0, NULL, 0, &result);
			}
			ov_string_setvalue(&response->contentString, "{\"PropertyIDList\":[");
			for (OV_UINT i = 0; i < result.veclen; i++){
				if (i != 0){
					ov_string_append(&response->contentString, ",");
				}
				ov_string_append(&response->contentString, "\"");
				ov_string_append(&response->contentString, result.value[i]);
				ov_string_append(&response->contentString, "\"");
			}
			ov_string_append(&response->contentString, "]}");
			Ov_SetDynamicVectorLength(&result, 0, STRING);
			ov_string_setvalue(&response->contentType, "application/json; charset=utf-8");
			return OV_ERR_OK;
			}
		break;
		case 6: // getExpressionSemanticList
			{
			OV_INSTPTR_openAASDiscoveryServer_DBWrapper pDBWrapper = NULL;
			OV_VTBLPTR_openAASDiscoveryServer_DBWrapper pDBWrapperVTable = NULL;
			OV_STRING tmpFields = "Value";
			OV_STRING_VEC result;
			result.value = NULL;
			result.veclen = 0;
			OV_STRING table = "ExpressionSemantic";
			if (pExt->v_pDiscoveryServer->p_Registration.v_DBWrapper.veclen > 0){
				pDBWrapper = Ov_DynamicPtrCast(openAASDiscoveryServer_DBWrapper, ov_path_getobjectpointer(pExt->v_pDiscoveryServer->p_Registration.v_DBWrapper.value[0], 2));
				if (!pDBWrapper){
					KS_logfile_info(("Could not get database Pointer"));
					ov_string_setvalue(&response->contentString, "Internal Error\n");
					return OV_ERR_OK;
				}
				Ov_GetVTablePtr(openAASDiscoveryServer_DBWrapper,pDBWrapperVTable, pDBWrapper);
				pDBWrapperVTable->m_selectData(pDBWrapper, table, &tmpFields, 1, NULL, 0, NULL, 0, &result);
			}
			ov_string_setvalue(&response->contentString, "{\"ExpressionSemanticList\":[");
			for (OV_UINT i = 0; i < result.veclen; i++){
				if (i != 0){
					ov_string_append(&response->contentString, ",");
				}
				ov_string_append(&response->contentString, "\"");
				ov_string_append(&response->contentString, result.value[i]);
				ov_string_append(&response->contentString, "\"");
			}
			ov_string_append(&response->contentString, "]}");
			Ov_SetDynamicVectorLength(&result, 0, STRING);
			ov_string_setvalue(&response->contentType, "application/json; charset=utf-8");
			return OV_ERR_OK;
			}
		break;
		case 7: // getRelationList
			{
			OV_INSTPTR_openAASDiscoveryServer_DBWrapper pDBWrapper = NULL;
			OV_VTBLPTR_openAASDiscoveryServer_DBWrapper pDBWrapperVTable = NULL;
			OV_STRING tmpFields = "Value";
			OV_STRING_VEC result;
			result.value = NULL;
			result.veclen = 0;
			OV_STRING table = "Relation";
			if (pExt->v_pDiscoveryServer->p_Registration.v_DBWrapper.veclen > 0){
				pDBWrapper = Ov_DynamicPtrCast(openAASDiscoveryServer_DBWrapper, ov_path_getobjectpointer(pExt->v_pDiscoveryServer->p_Registration.v_DBWrapper.value[0], 2));
				if (!pDBWrapper){
					KS_logfile_info(("Could not get database Pointer"));
					ov_string_setvalue(&response->contentString, "Internal Error\n");
					return OV_ERR_OK;
				}
				Ov_GetVTablePtr(openAASDiscoveryServer_DBWrapper,pDBWrapperVTable, pDBWrapper);
				pDBWrapperVTable->m_selectData(pDBWrapper, table, &tmpFields, 1, NULL, 0, NULL, 0, &result);
			}
			ov_string_setvalue(&response->contentString, "{\"RelationList\":[");
			for (OV_UINT i = 0; i < result.veclen; i++){
				if (i != 0){
					ov_string_append(&response->contentString, ",");
				}
				ov_string_append(&response->contentString, "\"");
				ov_string_append(&response->contentString, result.value[i]);
				ov_string_append(&response->contentString, "\"");
			}
			ov_string_append(&response->contentString, "]}");
			Ov_SetDynamicVectorLength(&result, 0, STRING);
			ov_string_setvalue(&response->contentType, "application/json; charset=utf-8");
			return OV_ERR_OK;
			}
		break;
		case 8: // getSubModelList
			{
			OV_INSTPTR_openAASDiscoveryServer_DBWrapper pDBWrapper = NULL;
			OV_VTBLPTR_openAASDiscoveryServer_DBWrapper pDBWrapperVTable = NULL;
			OV_STRING tmpFields = "Value";
			OV_STRING_VEC result;
			result.value = NULL;
			result.veclen = 0;
			OV_STRING table = "SubModel";
			if (pExt->v_pDiscoveryServer->p_Registration.v_DBWrapper.veclen > 0){
				pDBWrapper = Ov_DynamicPtrCast(openAASDiscoveryServer_DBWrapper, ov_path_getobjectpointer(pExt->v_pDiscoveryServer->p_Registration.v_DBWrapper.value[0], 2));
				if (!pDBWrapper){
					KS_logfile_info(("Could not get database Pointer"));
					ov_string_setvalue(&response->contentString, "Internal Error\n");
					return OV_ERR_OK;
				}
				Ov_GetVTablePtr(openAASDiscoveryServer_DBWrapper,pDBWrapperVTable, pDBWrapper);
				pDBWrapperVTable->m_selectData(pDBWrapper, table, &tmpFields, 1, NULL, 0, NULL, 0, &result);
			}
			ov_string_setvalue(&response->contentString, "{\"SubModelList\":[");
			for (OV_UINT i = 0; i < result.veclen; i++){
				if (i != 0){
					ov_string_append(&response->contentString, ",");
				}
				ov_string_append(&response->contentString, "\"");
				ov_string_append(&response->contentString, result.value[i]);
				ov_string_append(&response->contentString, "\"");
			}
			ov_string_append(&response->contentString, "]}");
			Ov_SetDynamicVectorLength(&result, 0, STRING);
			ov_string_setvalue(&response->contentType, "application/json; charset=utf-8");
			return OV_ERR_OK;
			}
		break;
		default:
			json_data_deleteMembers(&jsonData);
			KS_logfile_info(("incompatible requestMethod %s for openaasHTTP Extension", request.requestMethod));
			ov_string_setvalue(&response->contentString, "bad requestMethod for handler\n");
			return OV_ERR_BADPARAM;
		break;
	}
	json_data_deleteMembers(&jsonData);
	if (errorMessage){
		ov_string_setvalue(&JsonOutput, NULL);
		KS_logfile_info(("Error in part-function: %s", errorMessage));
		ov_string_setvalue(&response->contentString, errorMessage);
		ov_string_setvalue(&errorMessage, NULL);
		return OV_ERR_OK;
	}
	ov_string_setvalue(&response->contentString, (JsonOutput+7));
	ov_string_setvalue(&JsonOutput, NULL);
	ov_string_setvalue(&errorMessage, NULL);
	ov_string_setvalue(&response->contentType, "application/json; charset=utf-8");

	response->keepAlive = FALSE;

    return OV_ERR_OK;
}

