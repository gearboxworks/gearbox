
/******************************************************************************
*
*   FILE
*   ----
*   AASComponentManager.c
*
*   History
*   -------
*   2017-05-16   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_openaas
#define OV_COMPILE_LIBRARY_openaas
#endif


#include "openaas.h"
#include "libov/ov_macros.h"
#include "libov/ov_object.h"
#include "openaas_helpers.h"
#include "jsonparsing.h"
#include "fb_database.h"
#include "identification_helpers.h"
#include "propertyValueStatement_helpers.h"
#include "MessageSys_helpers.h"
#include "json_helper.h"

extern OV_INSTPTR_openaas_InterfaceDiscoveryServer pInterfaceDiscoveryServer;
static OV_INT LOCALMSGCOUNTER;

OV_DLLFNCEXPORT OV_RESULT openaas_AASComponentManager_reset_set(
    OV_INSTPTR_openaas_AASComponentManager          pobj,
    const OV_BOOL  value
) {
	if (value == TRUE){
		pobj->v_state = 6;
	}
    pobj->v_reset = FALSE;
    return OV_ERR_OK;
}



OV_DLLFNCEXPORT OV_RESULT openaas_AASComponentManager_constructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*
    *   local variables
    */
    OV_INSTPTR_openaas_AASComponentManager pinst = Ov_StaticPtrCast(openaas_AASComponentManager, pobj);
    OV_RESULT    result;

    /* do what the base class does first */
    result = fb_functionblock_constructor(pobj);
    if(Ov_Fail(result))
         return result;

    /* do what */
    if (!Ov_CanCastTo(openaas_aas, pinst->v_pouterobject)){
		ov_logfile_error("Can not created without an parent AAS");
		return OV_ERR_BADPATH;
	}

    pinst->v_iexreq = TRUE;
    pinst->v_actimode = 1;
    OV_INSTPTR_fb_task pTaskParent = NULL;
    pinst->v_messageBoxIsFiFo = TRUE;
    pinst->v_messageBoxSize = 10;
    pinst->v_state = 0;
    pinst->v_messageTimeOut.secs = 5;
    pinst->v_messageTimeOut.usecs = 0;
    pTaskParent = (OV_INSTPTR_fb_task)fb_database_geturtask();
    if (pTaskParent != NULL){
    	Ov_Link(fb_tasklist, pTaskParent, pinst);
    }
    else {
    	ov_logfile_error("Cannot link StateMachine to tasklist", pinst->v_identifier);
    }

    return OV_ERR_OK;
}



OV_DLLFNCEXPORT OV_ACCESS openaas_AASComponentManager_getaccess(
	OV_INSTPTR_ov_object	pobj,
	const OV_ELEMENT		*pelem,
	const OV_TICKET			*pticket
) {
    /*    
    *   local variables
    */

	switch(pelem->elemtype) {
		case OV_ET_VARIABLE:
			if(pelem->elemunion.pvar->v_offset >= offsetof(OV_INST_ov_object,__classinfo)) {
				if(pelem->elemunion.pvar->v_vartype == OV_VT_CTYPE)
					return OV_AC_NONE;
				else{
					if((pelem->elemunion.pvar->v_varprops & OV_VP_DERIVED)){
						if((pelem->elemunion.pvar->v_varprops & OV_VP_SETACCESSOR)){
							return OV_AC_READWRITE;
						} else {
							return OV_AC_READ;
						}
					} else {
						return OV_AC_READWRITE;
					}
				}
			}
		break;
		default:
		break;
	}

	return ov_object_getaccess(pobj, pelem, pticket);
}


static OV_INSTPTR_MessageSys_Message getNextMessage(OV_INSTPTR_openaas_AASComponentManager this) {
	OV_INSTPTR_ov_object child = NULL;

	//Check if we have a Message if(FiFo) else(Stack)
	if (this->v_messageBoxIsFiFo == TRUE) {
		// Get the first child that can be casted to Message.
		child = Ov_GetFirstChild(ov_containment, &this->p_INBOX);
		while (child && !Ov_CanCastTo(MessageSys_Message , child)) {
			child = Ov_GetNextChild(ov_containment, child);
		}
	} else {
		// Get the last child that can be casted to Message.
		child = Ov_GetLastChild(ov_containment, &this->p_INBOX);
		while (child && !Ov_CanCastTo(MessageSys_Message , child)) {
			child = Ov_GetPreviousChild(ov_containment, child);
		}
	}
	return (OV_INSTPTR_MessageSys_Message) child;
}

static void cleanupMessageBox(OV_INSTPTR_openaas_AASComponentManager this) {
	int nMessagesToDelete = 0;
	int nMessagesDeleted = 0;
	OV_INSTPTR_ov_object pChild = NULL;
	OV_INSTPTR_MessageSys_Message pMessageToDelete = NULL;

	// Calculate the number of messages to delete.
	Ov_ForEachChild(ov_containment, &this->p_INBOX, pChild) {
		if (Ov_CanCastTo(MessageSys_Message, pChild)) {
			nMessagesToDelete++;
		}
	}
	nMessagesToDelete = nMessagesToDelete - this->v_messageBoxSize;

	// Delete the messages.
	// TODO: To be optimized.
	while (nMessagesDeleted < nMessagesToDelete) {
		// Find a message to delete.
		pMessageToDelete = NULL;
		Ov_ForEachChild(ov_containment, &this->p_INBOX, pChild) {
			if (!Ov_CanCastTo(MessageSys_Message, pChild)) {
				continue;
			}
			if (this->v_messageBoxIsFiFo) {
				if (pMessageToDelete == NULL || ov_time_compare(&pMessageToDelete->v_creationtime, &pChild->v_creationtime) == OV_TIMECMP_AFTER) {
					pMessageToDelete = (OV_INSTPTR_MessageSys_Message) pChild;
				}
			} else {
				if (pMessageToDelete == NULL || ov_time_compare(&pMessageToDelete->v_creationtime, &pChild->v_creationtime) == OV_TIMECMP_BEFORE) {
					pMessageToDelete = (OV_INSTPTR_MessageSys_Message) pChild;
				}
			}
		}
		// Delete the message.
		Ov_DeleteObject(pMessageToDelete);
		nMessagesDeleted++;
	}
	return;
}


// RequestType:
// 0:SecurityRequest
// 1:RegistrationRequest
// 2:SearchRequest
// 3:UnregistrationRequest
static OV_STRING sendingRequestToDiscoveryServer(OV_INSTPTR_openaas_AASComponentManager this, OV_UINT requestType, const IdentificationType* requestedAASId) {
	OV_INSTPTR_openaas_aas paas;
	OV_STRING tmpString = NULL;
	OV_STRING SenderEndpoint = NULL;
	OV_STRING ReceiverEndpoint = NULL;
	OV_RESULT resultOV = OV_ERR_OK;
	OV_STRING componentID = NULL;
	OV_STRING certificate = NULL;
	OV_STRING componentContent = NULL;
	OV_INSTPTR_MessageSys_Message pRequestMessage = NULL;
	OV_INSTPTR_MessageSys_MsgDelivery pmsgDelivery = NULL;
	OV_STRING httpEndpoint = NULL;
	// Create MessageObject in Outbox
	paas = Ov_StaticPtrCast(openaas_aas,this->v_pouterobject);
	resultOV = Ov_CreateObject(MessageSys_Message, pRequestMessage, &this->p_OUTBOX, "Request");
	if(Ov_Fail(resultOV)){
		ov_logfile_error("Could not create an request Message. Reason: %s", ov_result_getresulttext(resultOV));
		return NULL;
	}

	// Sender = this AASComponentManager
	if (pInterfaceDiscoveryServer == NULL){
		Ov_DeleteObject((OV_INSTPTR_ov_object) pRequestMessage);
		ov_logfile_error("Could not find InterfaceDiscoveryServer");
		return NULL;
	}
	MessageSys_Message_senderAddress_set(pRequestMessage, pInterfaceDiscoveryServer->v_IPAddressServer);
	ov_string_setvalue(&SenderEndpoint, pInterfaceDiscoveryServer->v_IPAddressServer);
	// ServerName
	OV_STRING servername = NULL;
	OV_ANY srvnameprops;
	ov_vendortree_getservername(&srvnameprops, NULL);
	ov_string_setvalue(&servername,srvnameprops.value.valueunion.val_string);
	MessageSys_Message_senderName_set(pRequestMessage,servername);
	ov_string_append(&SenderEndpoint, ":");
	ov_string_append(&SenderEndpoint, servername);
	ov_string_setvalue(&servername, NULL);

	// Path
	ov_memstack_lock();
	MessageSys_Message_senderComponent_set(pRequestMessage, ov_path_getcanonicalpath(Ov_PtrUpCast(ov_object,this), 2));
	ov_string_append(&SenderEndpoint, ":");
	ov_string_append(&SenderEndpoint, ov_path_getcanonicalpath(Ov_PtrUpCast(ov_object,this), 2));
	ov_memstack_unlock();

	// Receiver = DiscoveryServer
	MessageSys_Message_receiverAddress_set(pRequestMessage, pInterfaceDiscoveryServer->v_IPAddressAASDiscoveryServer);
	ov_string_setvalue(&ReceiverEndpoint, pInterfaceDiscoveryServer->v_IPAddressAASDiscoveryServer);
	MessageSys_Message_receiverName_set(pRequestMessage, pInterfaceDiscoveryServer->v_ManagerNameAASDiscoveryServer);
	ov_string_append(&ReceiverEndpoint, ":");
	ov_string_append(&ReceiverEndpoint, pInterfaceDiscoveryServer->v_ManagerNameAASDiscoveryServer);
	ov_string_setvalue(&tmpString, pInterfaceDiscoveryServer->v_PathToAASDiscoveryServer);
	ov_string_append(&ReceiverEndpoint, ":");
	ov_string_append(&ReceiverEndpoint, pInterfaceDiscoveryServer->v_PathToAASDiscoveryServer);
	ov_string_append(&tmpString, ".ComponentManager");
	ov_string_append(&ReceiverEndpoint, ".ComponentManager");
	MessageSys_Message_receiverComponent_set(pRequestMessage, tmpString);
	ov_string_setvalue(&tmpString, NULL);

	ov_string_print(&componentID, "%i", paas->p_AASID.v_IdType);
	ov_string_append(&componentID, ",");
	ov_string_append(&componentID, paas->p_AASID.v_IdSpec);

	// Body
	// XML Encoding
	OV_STRING answerBody = NULL;
	ov_string_setvalue(&answerBody, "<bdy>");
	switch(requestType){
	case 0:
		// TODO: get certificate from PVS
		ov_string_setvalue(&certificate, "certificateOf");
		ov_string_append(&certificate, componentID);
		ov_string_print(&tmpString, "{ \"header\":{\"endpointSender\":\"%s\", \"endpointReceiver\":\"%s\", \"messageID\":\"%i\", \"messageType\":\"1\", \"protocolType\":\"1\"},\"body\":{\"componentID\":\"%s\", \"certificate\":\"%s\"}}", SenderEndpoint, ReceiverEndpoint, MessageSys_Message_msgID_get(pRequestMessage), componentID, certificate);
		ov_string_append(&answerBody, tmpString);
		ov_string_setvalue(&tmpString, NULL);
		ov_string_setvalue(&certificate, NULL);
		break;
	case 1:
		// TODO: get ComponentContent from AAS
		ov_memstack_lock();
		ov_string_print(&componentContent, "\"endpoints\":[{\"protocolType\":\"acplt_ks\",\"endpointSring\":\"%s\"}", SenderEndpoint);
		if(ov_library_search("openaasHTTP") != NULL){ // http-Endpoint
			OV_INSTPTR_TCPbind_TCPListener tcpListener = Ov_DynamicPtrCast(TCPbind_TCPListener, ov_path_getobjectpointer("/communication/TCPbind/TCPListener", 2));
			ov_string_print(&httpEndpoint, "%s:%i%s/aas", pInterfaceDiscoveryServer->v_IPAddressServer, tcpListener->v_port, ov_path_getcanonicalpath(Ov_PtrUpCast(ov_object,paas), 2));
			ov_string_print(&tmpString, ",{\"protocolType\":\"http\",\"endpointString\":\"%s\"}", httpEndpoint);
			ov_string_append(&componentContent, tmpString);
			ov_string_setvalue(&tmpString, NULL);
			ov_string_setvalue(&httpEndpoint, NULL);
		}
		if (pInterfaceDiscoveryServer->v_OPCUANamespaceIndex != 0){ // TODO: Check if OPCUA Server is running and getting nsindex
			tmpString = NULL;
			ov_string_print(&tmpString, ",{\"protocolType\":\"opcua\",\"endpointString\":\"opc.tcp://%s:16664;nsindex=%i, nodeId=%s\"}", pInterfaceDiscoveryServer->v_IPAddressServer, pInterfaceDiscoveryServer->v_OPCUANamespaceIndex, ov_path_getcanonicalpath(Ov_PtrUpCast(ov_object,this), 2));
			ov_string_append(&componentContent, tmpString);
			ov_string_setvalue(&tmpString, NULL);
		}
		ov_memstack_unlock();

		ov_string_append(&componentContent, "],");

		tmpString = getStatementsInJSON(paas);
		ov_string_append(&componentContent, tmpString);
		ov_string_setvalue(&tmpString, NULL);
		ov_string_print(&tmpString, "{ \"header\":{\"endpointSender\":\"%s\", \"endpointReceiver\":\"%s\", \"messageID\":\"%i\", \"messageType\":\"3\", \"protocolType\":\"1\"},\"body\":{\"componentID\":\"%s\", \"securityKey\":\"%s\", %s}}", SenderEndpoint, ReceiverEndpoint, MessageSys_Message_msgID_get(pRequestMessage), componentID, this->v_securityKey, componentContent);
		ov_string_setvalue(&componentContent, NULL);
		ov_string_append(&answerBody, tmpString);
		ov_string_setvalue(&tmpString, NULL);
		break;
	case 2:
		break;
	case 3:
		ov_string_print(&tmpString, "{ \"header\":{\"endpointSender\":\"%s\", \"endpointReceiver\":\"%s\", \"messageID\":\"%i\", \"messageType\":\"5\", \"protocolType\":\"1\"},\"body\":{\"componentID\":\"%s\", \"securityKey\":\"%s\"}}", SenderEndpoint, ReceiverEndpoint, MessageSys_Message_msgID_get(pRequestMessage), componentID, this->v_securityKey);
		ov_string_append(&answerBody, tmpString);
		ov_string_setvalue(&tmpString, NULL);
		break;
	default:
		Ov_DeleteObject((OV_INSTPTR_ov_object) pRequestMessage);
		ov_logfile_error("requestType not supported");
		ov_string_setvalue(&answerBody, NULL);
		return NULL;
		break;
	}
	ov_string_setvalue(&componentID, NULL);
	ov_string_append(&answerBody, "</bdy>");
	ov_string_setvalue(&pRequestMessage->v_msgBody, answerBody);
	ov_string_setvalue(&answerBody, NULL);
	ov_string_setvalue(&ReceiverEndpoint, NULL);
	ov_string_setvalue(&SenderEndpoint, NULL);

	// Message ready for sending
	pRequestMessage->v_msgStatus = MSGREADYFORSENDING;

	// Search for MsgDelivery object
	Ov_ForEachChildEx(ov_instantiation, pclass_MessageSys_MsgDelivery, pmsgDelivery, MessageSys_MsgDelivery){
		if(ov_string_compare(pmsgDelivery->v_identifier, "MessageSys") == OV_STRCMP_EQUAL){
			break;
		}
	}
	if (!pmsgDelivery){
		Ov_DeleteObject((OV_INSTPTR_ov_object) pRequestMessage);
		ov_logfile_error("Could not find MessageSys");
		return NULL;
	}

	// send Message
	if (MessageSys_MsgDelivery_sendMessage(pmsgDelivery, pRequestMessage) == FALSE){
		Ov_DeleteObject((OV_INSTPTR_ov_object) pRequestMessage);
		ov_logfile_error("Could not send Message");
		return NULL;
	}

	// MsgId
	return MessageSys_Message_msgID_get(pRequestMessage);
}




OV_DLLFNCEXPORT void openaas_AASComponentManager_typemethod(
	OV_INSTPTR_fb_functionblock	pfb,
	OV_TIME						*pltc
) {
    /*    
    *   local variables
    */

	OV_INSTPTR_openaas_AASComponentManager pinst = Ov_StaticPtrCast(openaas_AASComponentManager, pfb);
	OV_RESULT resultOV = OV_ERR_OK;
	AASStatusCode result = AASSTATUSCODE_GOOD;
	OV_INSTPTR_MessageSys_Message message = NULL;
	OV_STRING tempString = NULL;
	OV_INSTPTR_MessageSys_Message answerMessage = NULL;
	OV_INSTPTR_MessageSys_MsgDelivery pmsgDelivery = NULL;
	OV_INSTPTR_openaas_aas paas;
	OV_STRING messageContent = NULL;
	OV_UINT messageLength = 0;
	OV_UINT len = 0;
	OV_STRING *plistReq = NULL;
	OV_INSTPTR_fb_task pTaskParent = NULL;
	OV_TIME_SPAN tmpTimeSpan;
	OV_INSTPTR_ov_object pchild = NULL;
	response_data responseData;
	response_data_init(&responseData);

	// First clean message box, so only up-to-date messages are handled.
	cleanupMessageBox(pinst);
	ov_string_setvalue(&pinst->v_errorText, NULL);


	// StateMaschine
	switch(pinst->v_state){
	case 0: //Waiting for the setting of AAS-ID and Asset-ID
		pinst->v_messageCount = 0;
		pinst->v_registered = FALSE;


		paas = Ov_StaticPtrCast(openaas_aas,pinst->v_pouterobject);
		if(ov_string_compare(paas->p_AASID.v_IdSpec,"")==OV_STRCMP_EQUAL){
			break;
		}

		if(ov_string_compare(paas->p_AssetID.v_IdSpec,"")==OV_STRCMP_EQUAL){
			break;
		}

		//securityCheck AAS
		sendingRequestToDiscoveryServer(pinst, 0, NULL);
		pinst->v_state = 1;
		break;
	case 1: //Sending Security-Request and wait for answer
		// Get the next message, if any.
		ov_string_setvalue(&pinst->v_errorMessage, NULL);
		pinst->v_errorFlag = FALSE;
		pinst->v_messageCount++;
		pTaskParent=Ov_GetParent(fb_tasklist, pinst);
		tmpTimeSpan.usecs = pTaskParent->v_cyctime.usecs * pinst->v_messageCount;
		tmpTimeSpan.secs = pTaskParent->v_cyctime.secs * pinst->v_messageCount;
		while((OV_INT)tmpTimeSpan.usecs > 999999) {
			tmpTimeSpan.usecs -= 1000000;
			tmpTimeSpan.secs++;
		}
		if (tmpTimeSpan.secs > pinst->v_messageTimeOut.secs || (tmpTimeSpan.secs == pinst->v_messageTimeOut.secs && tmpTimeSpan.usecs > pinst->v_messageTimeOut.usecs)){
			pinst->v_messageCount = 0;
			sendingRequestToDiscoveryServer(pinst, 0, NULL);
		}
		message = getNextMessage(pinst);
		if (message == NULL) {
			// Nothing to do.
			return;
		}
		// Decoding the Message
		// XML Decoding
		if (strncmp(message->v_msgBody, "<bdy>", 5) != 0){ // <bdy> not found
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: <bdy> not found in msg. Reason");
			return;
		}
		messageLength = ov_string_getlength(message->v_msgBody);
		if (strncmp(&message->v_msgBody[messageLength-6], "</bdy>", 6) != 0){ // </bdy> not found
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: </bdy> not found in msg. Reason");
			return;
		}
		messageContent = malloc((messageLength-11+1)*sizeof(char));
		memcpy(messageContent, (message->v_msgBody+5), messageLength-11);
		messageContent[messageLength-11] = '\0';

		// TODO: SecurityResponse
		jsonResponseParse(&responseData, messageContent);
		free (messageContent);

		if (responseData.header.messageType != 2){
			// delete all used memory
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			response_data_deleteMembers(&responseData);
			return;
		}
		if (responseData.header.errorFlag == TRUE){
			pinst->v_errorFlag = TRUE;
			ov_string_setvalue(&pinst->v_errorMessage, responseData.header.errorMessage);
			pinst->v_state = 8;
			// delete all used memory
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			response_data_deleteMembers(&responseData);
			return;
		}
		// find certificate and securityKey
		// Parsing Body
		OV_STRING_VEC tags;
		tags.value = NULL;
		tags.veclen = 0;
		OV_STRING_VEC values;
		values.value = NULL;
		values.veclen = 0;
		Ov_SetDynamicVectorLength(&tags, 2, STRING);
		Ov_SetDynamicVectorLength(&values, 2, STRING);

		ov_string_setvalue(&tags.value[0], "certificate");
		ov_string_setvalue(&tags.value[1], "securityKey");

		jsonGetValuesByTags(tags, responseData.body, 1, &values);
		ov_string_setvalue(&pinst->v_certificateDS, values.value[0]);
		ov_string_setvalue(&pinst->v_securityKey, values.value[1]);
		Ov_SetDynamicVectorLength(&tags, 0, STRING);
		Ov_SetDynamicVectorLength(&values, 0, STRING);
		Ov_DeleteObject((OV_INSTPTR_ov_object) message);
		pinst->v_state = 2;
		sendingRequestToDiscoveryServer(pinst, 1, NULL);
		response_data_deleteMembers(&responseData);
	break;
	case 2: //Sending Registration-Request and wait for answer
		// Get the next message, if any.
		ov_string_setvalue(&pinst->v_errorMessage, NULL);
		pinst->v_errorFlag = FALSE;
		pinst->v_messageCount++;
		pTaskParent=Ov_GetParent(fb_tasklist, pinst);
		tmpTimeSpan.usecs = pTaskParent->v_cyctime.usecs * pinst->v_messageCount;
		tmpTimeSpan.secs = pTaskParent->v_cyctime.secs * pinst->v_messageCount;
		while((OV_INT)tmpTimeSpan.usecs > 999999) {
			tmpTimeSpan.usecs -= 1000000;
			tmpTimeSpan.secs++;
		}
		if (tmpTimeSpan.secs > pinst->v_messageTimeOut.secs || (tmpTimeSpan.secs == pinst->v_messageTimeOut.secs && tmpTimeSpan.usecs > pinst->v_messageTimeOut.usecs)){
			pinst->v_messageCount = 0;
			sendingRequestToDiscoveryServer(pinst, 1, NULL);
		}
		message = getNextMessage(pinst);
		if (message == NULL) {
			// Nothing to do.
			return;
		}
		// Decoding the Message
		// XML Decoding
		if (strncmp(message->v_msgBody, "<bdy>", 5) != 0){ // <bdy> not found
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: <bdy> not found in msg. Reason");
			return;
		}
		messageLength = ov_string_getlength(message->v_msgBody);
		if (strncmp(&message->v_msgBody[messageLength-6], "</bdy>", 6) != 0){ // </bdy> not found
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: </bdy> not found in msg. Reason");
			return;
		}
		messageContent = malloc((messageLength-11+1)*sizeof(char));
		memcpy(messageContent, (message->v_msgBody+5), messageLength-11);
		messageContent[messageLength-11] = '\0';

		// Check RegistrationResponse
		jsonResponseParse(&responseData, messageContent);
		free (messageContent);
		if (responseData.header.messageType != 4){
			// delete all used memory
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			response_data_deleteMembers(&responseData);
			return;
		}
		if (responseData.header.errorFlag == TRUE){
			pinst->v_errorFlag = TRUE;
			ov_string_setvalue(&pinst->v_errorMessage, responseData.header.errorMessage);
			pinst->v_state = 8;
			// delete all used memory
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			response_data_deleteMembers(&responseData);
			return;
		}
		pinst->v_state = 3; // no error
		pinst->v_registered = TRUE;
		Ov_DeleteObject((OV_INSTPTR_ov_object) message);
		response_data_deleteMembers(&responseData);
	break;
	case 3: //Process incoming messages
		// Get the next message, if any.
		ov_string_setvalue(&pinst->v_errorMessage, NULL);
		pinst->v_errorFlag = FALSE;
		message = getNextMessage(pinst);
		if (message == NULL) {
			// Nothing to do.
			return;
		}

		// Decoding the Message
		// XML Decoding
		if (strncmp(message->v_msgBody, "<bdy>", 5) != 0){ // <bdy> not found
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: <bdy> not found in msg. Reason");
			return;
		}
		messageLength = ov_string_getlength(message->v_msgBody);
		if (strncmp(&message->v_msgBody[messageLength-6], "</bdy>", 6) != 0){ // </bdy> not found
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: </bdy> not found in msg. Reason");
			return;
		}
		messageContent = malloc((messageLength-11+1)*sizeof(char));
		memcpy(messageContent, (message->v_msgBody+5), messageLength-11);
		messageContent[messageLength-11] = '\0';

		// JSON Decoding
		SRV_String *srvStringReceive = SRV_String_new();
		SRV_String_setCopy(srvStringReceive, messageContent, messageLength-11+1);
		free(messageContent);
		SRV_msgHeader *headerReceive = NULL;
		void *srvStructReceive = NULL;
		SRV_service_t srvTypeReceive;
		SRV_encoding_t encoding;
		resultOV = decodeMSG(srvStringReceive, &headerReceive, &srvStructReceive, &srvTypeReceive, &encoding);
		if (resultOV){
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: JSON Decoding message failed. Reason: %s", ov_result_getresulttext(resultOV));
			SRV_serviceGeneric_delete(srvStructReceive, srvTypeReceive);
			SRV_msgHeader_t_delete(headerReceive);
			SRV_String_delete(srvStringReceive);
			return;
		}

		// For encoding the message
		SRV_String *srvStringSend = NULL;
		SRV_msgHeader *headerSend = NULL;
		void *srvStructSend = NULL;
		SRV_service_t srvTypeSend;

		//Check if the parent is an AAS
		paas = Ov_StaticPtrCast(openaas_aas,pinst->v_pouterobject);
		IdentificationType aasId;
		IdentificationType_init(&aasId);
		ov_string_setvalue(&aasId.IdSpec, paas->p_AASID.v_IdSpec);
		aasId.IdType = paas->p_AASID.v_IdType;

		IdentificationType receiver;
		IdentificationType_init(&receiver);
		ov_string_setvalue(&receiver.IdSpec, headerReceive->receiver.idSpec.data);
		receiver.IdType = headerReceive->receiver.idType;
		OV_BOOL sendAnswer = FALSE;

		if (IdentificationTypeEqual(&receiver, &aasId)){ // MSG is for this AAS
			headerSend = SRV_msgHeader_t_reverseCopy(headerReceive);
			switch (srvTypeReceive){
			case SRV_createAASReq:{
				if (ov_string_compare(paas->v_identifier, "ComCo") == OV_STRCMP_EQUAL){ // This AAS is the ComCo
					createAASReq_t *createAASReq = (createAASReq_t*)srvStructReceive;

					IdentificationType tmpOVAASId;
					IdentificationType_init(&tmpOVAASId);
					ov_string_setvalue(&tmpOVAASId.IdSpec, createAASReq->aasId.idSpec.data);
					tmpOVAASId.IdType = createAASReq->aasId.idType;

					OV_STRING tmpOVName = NULL;
					ov_string_setvalue(&tmpOVName, createAASReq->aasName.data);

					IdentificationType tmpOVAssetId;
					IdentificationType_init(&tmpOVAssetId);
					ov_string_setvalue(&tmpOVAssetId.IdSpec, createAASReq->assetId.idSpec.data);
					tmpOVAssetId.IdType = createAASReq->assetId.idType;

					result = openaas_modelmanager_createAAS(tmpOVAASId, tmpOVName, tmpOVAssetId);

					createAASRsp_t createAASRsp;
					createAASRsp_t_init(&createAASRsp);

					createAASRsp.status = result;

					srvStructSend = &createAASRsp;
					srvTypeSend = SRV_createAASRsp;

					resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

					createAASRsp_t_deleteMembers(&createAASRsp);
					IdentificationType_deleteMembers(&tmpOVAASId);
					IdentificationType_deleteMembers(&tmpOVAssetId);
					ov_database_free(tmpOVName);
				}else{
					createAASRsp_t createAASRsp;
					createAASRsp_t_init(&createAASRsp);

					createAASRsp.status = AASSTATUSCODE_BADAASID;

					srvStructSend = &createAASRsp;
					srvTypeSend = SRV_createAASRsp;

					resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

					createAASRsp_t_deleteMembers(&createAASRsp);
				}
				sendAnswer = TRUE;
			}break;
			case SRV_createAASRsp:{
				// TODO: Check the answer
			}break;
			case SRV_deleteAASReq:{
				if (ov_string_compare(paas->v_identifier, "ComCo") == OV_STRCMP_EQUAL){ // This AAS is the ComCo
					deleteAASReq_t *deleteAASReq = (deleteAASReq_t*)srvStructReceive;

					IdentificationType tmpOVAASId;
					IdentificationType_init(&tmpOVAASId);
					ov_string_setvalue(&tmpOVAASId.IdSpec, deleteAASReq->aasId.idSpec.data);
					tmpOVAASId.IdType = deleteAASReq->aasId.idType;


					result = openaas_modelmanager_deleteAAS(tmpOVAASId);

					deleteAASRsp_t deleteAASRsp;
					deleteAASRsp_t_init(&deleteAASRsp);

					deleteAASRsp.status = result;

					srvStructSend = &deleteAASRsp;
					srvTypeSend = SRV_deleteAASRsp;

					resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

					deleteAASRsp_t_deleteMembers(&deleteAASRsp);
					IdentificationType_deleteMembers(&tmpOVAASId);
				}else{
					deleteAASRsp_t deleteAASRsp;
					deleteAASRsp_t_init(&deleteAASRsp);

					deleteAASRsp.status = AASSTATUSCODE_BADAASID;

					srvStructSend = &deleteAASRsp;
					srvTypeSend = SRV_deleteAASRsp;

					resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

					deleteAASRsp_t_deleteMembers(&deleteAASRsp);
				}
				sendAnswer = TRUE;
			}break;
			case SRV_deleteAASRsp:{
				// TODO: Check the answer
			}break;
			case SRV_createSubModelReq:{
				createSubModelReq_t *createSubModelReq = (createSubModelReq_t*)srvStructReceive;

				IdentificationType tmpOVparentID;
				IdentificationType_init(&tmpOVparentID);
				ov_string_setvalue(&tmpOVparentID.IdSpec, createSubModelReq->parentId.idSpec.data);
				tmpOVparentID.IdType = createSubModelReq->parentId.idType;

				IdentificationType tmpOVmodelId;
				IdentificationType_init(&tmpOVmodelId);
				ov_string_setvalue(&tmpOVmodelId.IdSpec, createSubModelReq->modelId.idSpec.data);
				tmpOVmodelId.IdType = createSubModelReq->modelId.idType;

				OV_STRING tmpOVsmName = NULL;
				ov_string_setvalue(&tmpOVsmName, createSubModelReq->name.data);

				OV_UINT tmpOVrevision = createSubModelReq->revision;

				OV_UINT tmpOVversion = createSubModelReq->version;


				result = openaas_modelmanager_createSubModel(aasId, tmpOVparentID, tmpOVmodelId, tmpOVsmName, tmpOVrevision, tmpOVversion);

				createSubModelRsp_t createSubModelRsp;
				createSubModelRsp_t_init(&createSubModelRsp);

				createSubModelRsp.status = result;

				srvStructSend = &createSubModelRsp;
				srvTypeSend = SRV_createSubModelRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				createSubModelRsp_t_deleteMembers(&createSubModelRsp);
				IdentificationType_deleteMembers(&tmpOVparentID);
				IdentificationType_deleteMembers(&tmpOVmodelId);
				ov_string_setvalue(&tmpOVsmName, NULL);
				sendAnswer = TRUE;
			}break;
			case SRV_createSubModelRsp:{
				// TODO: Check the answer
			}break;
			case SRV_deleteSubModelReq:{
				deleteSubModelReq_t *deleteSubModelReq = (deleteSubModelReq_t*)srvStructReceive;

				IdentificationType tmpOVmodelId;
				IdentificationType_init(&tmpOVmodelId);
				ov_string_setvalue(&tmpOVmodelId.IdSpec, deleteSubModelReq->modelId.idSpec.data);
				tmpOVmodelId.IdType = deleteSubModelReq->modelId.idType;

				result = openaas_modelmanager_deleteSubModel(aasId, tmpOVmodelId);

				deleteSubModelRsp_t deleteSubModelRsp;
				deleteSubModelRsp_t_init(&deleteSubModelRsp);

				deleteSubModelRsp.status = result;

				srvStructSend = &deleteSubModelRsp;
				srvTypeSend = SRV_deleteSubModelRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				deleteSubModelRsp_t_deleteMembers(&deleteSubModelRsp);
				IdentificationType_deleteMembers(&tmpOVmodelId);
				sendAnswer = TRUE;
			}break;
			case SRV_deleteSubModelRsp:{
				// TODO: Check the answer
			}break;
			case SRV_createPVSLReq:{
				createPVSLReq_t *createPVSLReq = (createPVSLReq_t*)srvStructReceive;

				IdentificationType tmpOVParentId;
				IdentificationType_init(&tmpOVParentId);
				ov_string_setvalue(&tmpOVParentId.IdSpec, createPVSLReq->parentId.idSpec.data);
				tmpOVParentId.IdType = createPVSLReq->parentId.idType;

				OV_STRING tmpOVPvslName = NULL;
				ov_string_setvalue(&tmpOVPvslName, createPVSLReq->pvsl.preferredName.data);

				OV_UINT tmpOVMask = 0;

				IdentificationType tmpOVCarrierId;
				IdentificationType_init(&tmpOVCarrierId);
				if (createPVSLReq->pvsl.carrierId.idType != SRV_IDT_undefined){
					ov_string_setvalue(&tmpOVCarrierId.IdSpec, createPVSLReq->pvsl.carrierId.idSpec.data);
					tmpOVCarrierId.IdType = createPVSLReq->pvsl.carrierId.idType;
					tmpOVMask |= 0x01;
				}

				ExpressionLogicEnum tmpOVExpressionLogic = createPVSLReq->pvsl.expressionLogic;
				if (createPVSLReq->pvsl.expressionLogic != SRV_EL_undefined){
					tmpOVMask |= 0x02;
				}

				ExpressionSemanticEnum tmpOVExpressionSemantic = createPVSLReq->pvsl.expressionSemantic;
				if (createPVSLReq->pvsl.expressionSemantic != SRV_ES_undefined){
					tmpOVMask |= 0x04;
				}

				IdentificationType tmpOVPropertyId;
				IdentificationType_init(&tmpOVPropertyId);
				if (createPVSLReq->pvsl.carrierId.idType != SRV_IDT_undefined){
					ov_string_setvalue(&tmpOVPropertyId.IdSpec, createPVSLReq->pvsl.propertyId.idSpec.data);
					tmpOVPropertyId.IdType = createPVSLReq->pvsl.propertyId.idType;
					tmpOVMask |= 0x08;
				}

				ViewEnum tmpOVView = createPVSLReq->pvsl.view;
				if (createPVSLReq->pvsl.view != SRV_VIEW_undefined){
					tmpOVMask |= 0x10;
				}

				VisibilityEnum tmpOVVisibility = createPVSLReq->pvsl.visibility;
				if (createPVSLReq->pvsl.visibility != SRV_VIS_undefined){
					tmpOVMask |= 0x20;
				}

				result = openaas_modelmanager_createPVSL(aasId, tmpOVParentId, tmpOVPvslName, tmpOVMask, tmpOVCarrierId,tmpOVExpressionLogic, tmpOVExpressionSemantic, tmpOVPropertyId, tmpOVView, tmpOVVisibility);

				createPVSLRsp_t createPVSLRsp;
				createPVSLRsp_t_init(&createPVSLRsp);

				createPVSLRsp.status = result;

				srvStructSend = &createPVSLRsp;
				srvTypeSend = SRV_createPVSLRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				createPVSLRsp_t_deleteMembers(&createPVSLRsp);
				IdentificationType_deleteMembers(&tmpOVParentId);
				ov_string_setvalue(&tmpOVPvslName, NULL);
				IdentificationType_deleteMembers(&tmpOVCarrierId);
				IdentificationType_deleteMembers(&tmpOVPropertyId);
				sendAnswer = TRUE;
			}break;
			case SRV_createPVSLRsp:{
				// TODO: Check the answer
			}break;
			case SRV_deletePVSLReq:{
				deletePVSLReq_t *deletePVSLReq = (deletePVSLReq_t*)srvStructReceive;

				IdentificationType tmpOVPVSList;
				IdentificationType_init(&tmpOVPVSList);
				ov_string_setvalue(&tmpOVPVSList.IdSpec, deletePVSLReq->id.idSpec.data);
				tmpOVPVSList.IdType = deletePVSLReq->id.idType;

				result = openaas_modelmanager_deletePVSL(aasId, tmpOVPVSList);

				deletePVSLRsp_t deletePVSLRsp;
				deletePVSLRsp_t_init(&deletePVSLRsp);

				deletePVSLRsp.status = result;

				srvStructSend = &deletePVSLRsp;
				srvTypeSend = SRV_deletePVSLRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				deletePVSLRsp_t_deleteMembers(&deletePVSLRsp);
				IdentificationType_deleteMembers(&tmpOVPVSList);
				sendAnswer = TRUE;
			}break;
			case SRV_deletePVSLRsp:{
				// TODO: Check the answer
			}break;
			case SRV_createPVSReq:{
				createPVSReq_t *createPVSReq = (createPVSReq_t*)srvStructReceive;

				IdentificationType tmpOVPVSListId;
				IdentificationType_init(&tmpOVPVSListId);
				ov_string_setvalue(&tmpOVPVSListId.IdSpec, createPVSReq->listId.idSpec.data);
				tmpOVPVSListId.IdType = createPVSReq->listId.idType;

				OV_STRING tmpOVPvsName = NULL;
				ov_string_setvalue(&tmpOVPvsName, createPVSReq->pvs.preferredName.data);

				OV_UINT tmpOVMask = 0;

				IdentificationType tmpOVCarrierId;
				IdentificationType_init(&tmpOVCarrierId);
				if (createPVSReq->pvs.carrierId.idType != SRV_IDT_undefined){
					ov_string_setvalue(&tmpOVCarrierId.IdSpec, createPVSReq->pvs.carrierId.idSpec.data);
					tmpOVCarrierId.IdType = createPVSReq->pvs.carrierId.idType;
					tmpOVMask |= 0x01;
				}

				ExpressionLogicEnum tmpOVExpressionLogic = createPVSReq->pvs.expressionLogic;
				if (createPVSReq->pvs.expressionLogic != SRV_EL_undefined){
					tmpOVMask |= 0x02;
				}

				ExpressionSemanticEnum tmpOVExpressionSemantic = createPVSReq->pvs.expressionSemantic;
				if (createPVSReq->pvs.expressionSemantic != SRV_ES_undefined){
					tmpOVMask |= 0x04;
				}

				IdentificationType tmpOVPropertyId;
				IdentificationType_init(&tmpOVPropertyId);
				if (createPVSReq->pvs.carrierId.idType != SRV_IDT_undefined){
					ov_string_setvalue(&tmpOVPropertyId.IdSpec, createPVSReq->pvs.propertyId.idSpec.data);
					tmpOVPropertyId.IdType = createPVSReq->pvs.propertyId.idType;
					tmpOVMask |= 0x08;
				}

				ViewEnum tmpOVView = createPVSReq->pvs.view;
				if (createPVSReq->pvs.view != SRV_VIEW_undefined){
					tmpOVMask |= 0x10;
				}

				VisibilityEnum tmpOVVisibility = createPVSReq->pvs.visibility;
				if (createPVSReq->pvs.visibility != SRV_VIS_undefined){
					tmpOVMask |= 0x20;
				}

				OV_ANY tmpOVValue;
				tmpOVValue.value.vartype = OV_VT_VOID;
				serviceValueToOVDataValue(&tmpOVValue, &createPVSReq->pvs.value);

				result = openaas_modelmanager_createPVS(aasId, tmpOVPVSListId, tmpOVPvsName, tmpOVValue, tmpOVMask, tmpOVCarrierId,tmpOVExpressionLogic, tmpOVExpressionSemantic, tmpOVPropertyId, tmpOVView, tmpOVVisibility);

				createPVSRsp_t createPVSRsp;
				createPVSRsp_t_init(&createPVSRsp);

				createPVSRsp.status = result;

				srvStructSend = &createPVSRsp;
				srvTypeSend = SRV_createPVSRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				createPVSRsp_t_deleteMembers(&createPVSRsp);
				IdentificationType_deleteMembers(&tmpOVPVSListId);
				ov_string_setvalue(&tmpOVPvsName, NULL);
				IdentificationType_deleteMembers(&tmpOVCarrierId);
				IdentificationType_deleteMembers(&tmpOVPropertyId);
				Ov_SetAnyValue(&tmpOVValue, NULL);
				sendAnswer = TRUE;
			}break;
			case SRV_createPVSRsp:{
				// TODO: Check the answer
			}break;
			case SRV_deletePVSReq:{
				deletePVSReq_t *deletePVSReq = (deletePVSReq_t*)srvStructReceive;

				IdentificationType tmpOVPVSList;
				IdentificationType_init(&tmpOVPVSList);
				ov_string_setvalue(&tmpOVPVSList.IdSpec, deletePVSReq->id.idSpec.data);
				tmpOVPVSList.IdType = deletePVSReq->id.idType;

				result = openaas_modelmanager_deletePVSL(aasId, tmpOVPVSList);

				deletePVSRsp_t deletePVSRsp;
				deletePVSRsp_t_init(&deletePVSRsp);

				deletePVSRsp.status = result;

				srvStructSend = &deletePVSRsp;
				srvTypeSend = SRV_deletePVSRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				deletePVSRsp_t_deleteMembers(&deletePVSRsp);
				IdentificationType_deleteMembers(&tmpOVPVSList);
				sendAnswer = TRUE;
			}break;
			case SRV_deletePVSRsp:{
				// TODO: Check the answer
			}break;
			case SRV_setPVSReq:{
				setPVSReq_t *setPVSReq = (setPVSReq_t*)srvStructReceive;

				IdentificationType tmpOVPVSId;
				IdentificationType_init(&tmpOVPVSId);
				ov_string_setvalue(&tmpOVPVSId.IdSpec, setPVSReq->id.idSpec.data);
				tmpOVPVSId.IdType = setPVSReq->id.idType;

				OV_UINT tmpOVMask = 0;

				OV_STRING tmpOVPvsName = NULL;
				if (setPVSReq->pvs.hasName == TRUE){
					ov_string_setvalue(&tmpOVPvsName, setPVSReq->pvs.preferredName.data);
					tmpOVMask |= 0x01;
				}

				IdentificationType tmpOVCarrierId;
				IdentificationType_init(&tmpOVCarrierId);
				if (setPVSReq->pvs.carrierId.idType != SRV_IDT_undefined){
					ov_string_setvalue(&tmpOVCarrierId.IdSpec, setPVSReq->pvs.carrierId.idSpec.data);
					tmpOVCarrierId.IdType = setPVSReq->pvs.carrierId.idType;
					tmpOVMask |= 0x02;
				}

				ExpressionLogicEnum tmpOVExpressionLogic = setPVSReq->pvs.expressionLogic;
				if (setPVSReq->pvs.expressionLogic != SRV_EL_undefined){
					tmpOVMask |= 0x04;
				}

				ExpressionSemanticEnum tmpOVExpressionSemantic = setPVSReq->pvs.expressionSemantic;
				if (setPVSReq->pvs.expressionSemantic != SRV_ES_undefined){
					tmpOVMask |= 0x08;
				}

				IdentificationType tmpOVPropertyId;
				IdentificationType_init(&tmpOVPropertyId);
				if (setPVSReq->pvs.carrierId.idType != SRV_IDT_undefined){
					ov_string_setvalue(&tmpOVPropertyId.IdSpec, setPVSReq->pvs.propertyId.idSpec.data);
					tmpOVPropertyId.IdType = setPVSReq->pvs.propertyId.idType;
					tmpOVMask |= 0x10;
				}

				ViewEnum tmpOVView = setPVSReq->pvs.view;
				if (setPVSReq->pvs.view != SRV_VIEW_undefined){
					tmpOVMask |= 0x20;
				}

				VisibilityEnum tmpOVVisibility = setPVSReq->pvs.visibility;
				if (setPVSReq->pvs.visibility != SRV_VIS_undefined){
					tmpOVMask |= 0x40;
				}

				OV_ANY tmpOVValue;
				tmpOVValue.value.vartype = OV_VT_VOID;
				if (setPVSReq->pvs.value.type != SRV_VT_undefined){
					serviceValueToOVDataValue(&tmpOVValue, &setPVSReq->pvs.value);
					tmpOVMask |= 0x80;
				}

				result = openaas_modelmanager_setPVS(aasId, tmpOVPVSId, tmpOVMask, tmpOVPvsName, tmpOVCarrierId,tmpOVExpressionLogic, tmpOVExpressionSemantic, tmpOVPropertyId, tmpOVView, tmpOVVisibility, tmpOVValue);

				setPVSRsp_t setPVSRsp;
				setPVSRsp_t_init(&setPVSRsp);

				setPVSRsp.status = result;

				srvStructSend = &setPVSRsp;
				srvTypeSend = SRV_setPVSRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				setPVSRsp_t_deleteMembers(&setPVSRsp);
				IdentificationType_deleteMembers(&tmpOVPVSId);
				ov_string_setvalue(&tmpOVPvsName, NULL);
				IdentificationType_deleteMembers(&tmpOVCarrierId);
				IdentificationType_deleteMembers(&tmpOVPropertyId);
				Ov_SetAnyValue(&tmpOVValue, NULL);
				sendAnswer = TRUE;
			}break;
			case SRV_setPVSRsp:{
				// TODO: Check the answer
			}break;
			case SRV_getPVSReq:{
				getPVSReq_t *getPVSReq = (getPVSReq_t*)srvStructReceive;

				IdentificationType tmpOVPVSId;
				IdentificationType_init(&tmpOVPVSId);
				ov_string_setvalue(&tmpOVPVSId.IdSpec, getPVSReq->id.idSpec.data);
				tmpOVPVSId.IdType = getPVSReq->id.idType;

				OV_STRING tmpOVPvsName = NULL;

				IdentificationType tmpOVCarrierId;
				IdentificationType_init(&tmpOVCarrierId);

				ExpressionLogicEnum tmpOVExpressionLogic;

				ExpressionSemanticEnum tmpOVExpressionSemantic;

				IdentificationType tmpOVPropertyId;
				IdentificationType_init(&tmpOVPropertyId);

				ViewEnum tmpOVView;

				VisibilityEnum tmpOVVisibility;

				OV_ANY tmpOVValue;
				tmpOVValue.value.vartype = OV_VT_VOID;


				result = openaas_modelmanager_getPVS(aasId, tmpOVPVSId, &tmpOVPvsName, &tmpOVCarrierId, &tmpOVExpressionLogic, &tmpOVExpressionSemantic, &tmpOVPropertyId, &tmpOVView, &tmpOVVisibility, &tmpOVValue);

				getPVSRsp_t getPVSRsp;
				getPVSRsp_t_init(&getPVSRsp);

				SRV_String_setCopy(&getPVSRsp.pvs.preferredName, tmpOVPvsName, ov_string_getlength(tmpOVPvsName));
				getPVSRsp.pvs.hasName = true;

				SRV_String_setCopy(&getPVSRsp.pvs.carrierId.idSpec, tmpOVCarrierId.IdSpec, ov_string_getlength(tmpOVCarrierId.IdSpec));
				getPVSRsp.pvs.carrierId.idType = tmpOVCarrierId.IdType;

				getPVSRsp.pvs.expressionLogic = tmpOVExpressionLogic;

				getPVSRsp.pvs.expressionSemantic = tmpOVExpressionSemantic;

				SRV_String_setCopy(&getPVSRsp.pvs.propertyId.idSpec, tmpOVPropertyId.IdSpec, ov_string_getlength(tmpOVPropertyId.IdSpec));
				getPVSRsp.pvs.propertyId.idType = tmpOVPropertyId.IdType;

				getPVSRsp.pvs.view = tmpOVView;

				getPVSRsp.pvs.visibility = tmpOVVisibility;

				OVDataValueToserviceValue(tmpOVValue, &getPVSRsp.pvs.value);

				getPVSRsp.status = result;

				srvStructSend = &getPVSRsp;
				srvTypeSend = SRV_getPVSRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				getPVSRsp_t_deleteMembers(&getPVSRsp);
				IdentificationType_deleteMembers(&tmpOVPVSId);
				ov_string_setvalue(&tmpOVPvsName, NULL);
				IdentificationType_deleteMembers(&tmpOVCarrierId);
				IdentificationType_deleteMembers(&tmpOVPropertyId);
				Ov_SetAnyValue(&tmpOVValue, NULL);
				sendAnswer = TRUE;
			}break;
			case SRV_getPVSRsp:{
				// TODO: Check the answer
			}break;
			case SRV_getCoreDataReq:{
				getCoreDataReq_t *getCoreDataReq = (getCoreDataReq_t*)srvStructReceive;
				OV_UINT tmpNumber = 0;

				PropertyValueStatementList *ppvsl = NULL;

				result = openaas_modelmanager_getCoreData(aasId, &tmpNumber, &ppvsl, getCoreDataReq->visibility);

				getCoreDataRsp_t getCoreDataRsp;
				getCoreDataRsp_t_init(&getCoreDataRsp);

				getCoreDataRsp.status = result;
				if (!result){
					getCoreDataRsp.numPvsl = tmpNumber;
					getCoreDataRsp.pvsl = malloc(sizeof(PVSL_t)*tmpNumber);
					for (OV_UINT i = 0; i < tmpNumber; i++){
						PVSL_t_init(&getCoreDataRsp.pvsl[i]);
						SRV_String_setCopy(&getCoreDataRsp.pvsl[i].preferredName, ppvsl[i].PvslName, ov_string_getlength(ppvsl[i].PvslName));
						getCoreDataRsp.pvsl[i].hasName = true;
						if (ppvsl[i].Mask & 0x01){ //CarrierID
							SRV_String_setCopy(&getCoreDataRsp.pvsl[i].carrierId.idSpec, ppvsl[i].CarrierId.IdSpec, ov_string_getlength(ppvsl[i].CarrierId.IdSpec));
							getCoreDataRsp.pvsl[i].carrierId.idType = ppvsl[i].CarrierId.IdType;
						}
						if (ppvsl[i].Mask & 0x02){ //ExpressionLogic
							getCoreDataRsp.pvsl[i].expressionLogic = ppvsl[i].ExpressionLogic;
						}
						if (ppvsl[i].Mask & 0x04){ //ExpressionSemantic
							getCoreDataRsp.pvsl[i].expressionSemantic = ppvsl[i].ExpressionSemantic;
						}
						if (ppvsl[i].Mask & 0x08){ //PropertyID
							SRV_String_setCopy(&getCoreDataRsp.pvsl[i].propertyId.idSpec, ppvsl[i].PropertyId.IdSpec, ov_string_getlength(ppvsl[i].PropertyId.IdSpec));
							getCoreDataRsp.pvsl[i].propertyId.idType = ppvsl[i].PropertyId.IdType;
						}
						if (ppvsl[i].Mask & 0x10){ //View
							getCoreDataRsp.pvsl[i].view = ppvsl[i].View;
						}
						if (ppvsl[i].Mask & 0x20){ //Visibility
							getCoreDataRsp.pvsl[i].visibility = ppvsl[i].Visibility;
						}

						getCoreDataRsp.pvsl[i].numPvs = ppvsl[i].pvsSize;
						if (getCoreDataRsp.pvsl[i].numPvs == 0)
							continue;
						getCoreDataRsp.pvsl[i].pvs = malloc(sizeof(PVS_t)*ppvsl[i].pvsSize);
						for (OV_UINT j = 0; j < ppvsl[i].pvsSize; j++){
							PVS_t_init(&getCoreDataRsp.pvsl[i].pvs[j]);
							SRV_String_setCopy(&getCoreDataRsp.pvsl[i].pvs[j].preferredName, ppvsl[i].pvs[j].PvsName, ov_string_getlength(ppvsl[i].pvs[j].PvsName));
							getCoreDataRsp.pvsl[i].pvs[j].hasName = true;
							if (ppvsl[i].pvs[j].Mask & 0x01){ //CarrierID
								SRV_String_setCopy(&getCoreDataRsp.pvsl[i].pvs[j].carrierId.idSpec, ppvsl[i].pvs[j].CarrierId.IdSpec, ov_string_getlength(ppvsl[i].pvs[j].CarrierId.IdSpec));
								getCoreDataRsp.pvsl[i].pvs[j].carrierId.idType = ppvsl[i].pvs[j].CarrierId.IdType;
							}
							if (ppvsl[i].pvs[j].Mask & 0x02){ //ExpressionLogic
								getCoreDataRsp.pvsl[i].pvs[j].expressionLogic = ppvsl[i].pvs[j].ExpressionLogic;
							}
							if (ppvsl[i].pvs[j].Mask & 0x04){ //ExpressionSemantic
								getCoreDataRsp.pvsl[i].pvs[j].expressionSemantic = ppvsl[i].pvs[j].ExpressionSemantic;
							}
							if (ppvsl[i].pvs[j].Mask & 0x08){ //PropertyID
								SRV_String_setCopy(&getCoreDataRsp.pvsl[i].pvs[j].propertyId.idSpec, ppvsl[i].pvs[j].PropertyId.IdSpec, ov_string_getlength(ppvsl[i].pvs[j].PropertyId.IdSpec));
								getCoreDataRsp.pvsl[i].pvs[j].propertyId.idType = ppvsl[i].pvs[j].PropertyId.IdType;
							}
							if (ppvsl[i].pvs[j].Mask & 0x10){ //View
								getCoreDataRsp.pvsl[i].pvs[j].view = ppvsl[i].pvs[j].View;
							}
							if (ppvsl[i].pvs[j].Mask & 0x20){ //Visibility
								getCoreDataRsp.pvsl[i].pvs[j].visibility = ppvsl[i].pvs[j].Visibility;
							}
							OVDataValueToserviceValue(ppvsl[i].pvs[j].Value, &getCoreDataRsp.pvsl[i].pvs[j].value);
						}
					}
				}
				for (OV_UINT i = 0; i < tmpNumber; i++){
					PropertyValueStatementList_deleteMembers(&ppvsl[i]);
				}
				ppvsl = NULL;

				srvStructSend = &getCoreDataRsp;
				srvTypeSend = SRV_getCoreDataRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);


				getCoreDataRsp_t_deleteMembers(&getCoreDataRsp);
				if(!resultOV)
					sendAnswer = TRUE;
			}break;
			case SRV_getCoreDataRsp:{
				getCoreDataRsp_t *getCoreDataRsp = (getCoreDataRsp_t*)srvStructReceive;

				if (!getCoreDataRsp->status){
					for (OV_UINT i = 0; i < getCoreDataRsp->numPvsl; i++){
						OV_STRING tmpOVPVSLName = NULL;
						ov_string_setvalue(&tmpOVPVSLName, getCoreDataRsp->pvsl[i].preferredName.data);

						IdentificationType tmpOVParentId;
						IdentificationType_init(&tmpOVParentId);
						ov_memstack_lock();
						ov_string_setvalue(&tmpOVParentId.IdSpec, ov_path_getcanonicalpath(Ov_DynamicPtrCast(ov_object,&paas->p_Body), 2));
						ov_memstack_unlock();
						tmpOVParentId.IdType = URI;

						OV_STRING tmpOVPvslName = NULL;
						ov_string_setvalue(&tmpOVPvslName, getCoreDataRsp->pvsl[i].preferredName.data);

						OV_UINT tmpOVMask = 0;

						IdentificationType tmpOVCarrierId;
						IdentificationType_init(&tmpOVCarrierId);
						if (getCoreDataRsp->pvsl[i].carrierId.idType != SRV_IDT_undefined){
							ov_string_setvalue(&tmpOVCarrierId.IdSpec, getCoreDataRsp->pvsl[i].carrierId.idSpec.data);
							tmpOVCarrierId.IdType = getCoreDataRsp->pvsl[i].carrierId.idType;
							tmpOVMask |= 0x01;
						}

						ExpressionLogicEnum tmpOVExpressionLogic = getCoreDataRsp->pvsl[i].expressionLogic;
						if (getCoreDataRsp->pvsl[i].expressionLogic != SRV_EL_undefined){
							tmpOVMask |= 0x02;
						}

						ExpressionSemanticEnum tmpOVExpressionSemantic = getCoreDataRsp->pvsl[i].expressionSemantic;
						if (getCoreDataRsp->pvsl[i].expressionSemantic != SRV_ES_undefined){
							tmpOVMask |= 0x04;
						}

						IdentificationType tmpOVPropertyId;
						IdentificationType_init(&tmpOVPropertyId);
						if (getCoreDataRsp->pvsl[i].propertyId.idType != SRV_IDT_undefined){
							ov_string_setvalue(&tmpOVPropertyId.IdSpec, getCoreDataRsp->pvsl[i].propertyId.idSpec.data);
							tmpOVPropertyId.IdType = getCoreDataRsp->pvsl[i].propertyId.idType;
							tmpOVMask |= 0x08;
						}

						ViewEnum tmpOVView = getCoreDataRsp->pvsl[i].view;
						if (getCoreDataRsp->pvsl[i].view != SRV_VIEW_undefined){
							tmpOVMask |= 0x10;
						}

						VisibilityEnum tmpOVVisibility = getCoreDataRsp->pvsl[i].visibility;
						if (getCoreDataRsp->pvsl[i].visibility != SRV_VIS_undefined){
							tmpOVMask |= 0x20;
						}

						result = openaas_modelmanager_createPVSL(aasId, tmpOVParentId, tmpOVPvslName, tmpOVMask, tmpOVCarrierId,tmpOVExpressionLogic, tmpOVExpressionSemantic, tmpOVPropertyId, tmpOVView, tmpOVVisibility);

						for (OV_UINT j = 0; j < getCoreDataRsp->pvsl[i].numPvs; j++){
							IdentificationType tmpOVPVSListId;
							IdentificationType_init(&tmpOVPVSListId);
							ov_memstack_lock();
							ov_string_setvalue(&tmpOVPVSListId.IdSpec, ov_path_getcanonicalpath(Ov_DynamicPtrCast(ov_object,&paas->p_Body), 2));
							ov_memstack_unlock();
							ov_string_append(&tmpOVPVSListId.IdSpec, "/");
							ov_string_append(&tmpOVPVSListId.IdSpec, getCoreDataRsp->pvsl[i].preferredName.data);
							tmpOVPVSListId.IdType = URI;

							OV_STRING tmpOVPvsName = NULL;
							ov_string_setvalue(&tmpOVPvsName, getCoreDataRsp->pvsl[i].pvs[j].preferredName.data);

							OV_UINT tmpOVMask = 0;

							IdentificationType tmpOVCarrierId;
							IdentificationType_init(&tmpOVCarrierId);
							if (getCoreDataRsp->pvsl[i].pvs[j].carrierId.idType != SRV_IDT_undefined){
								ov_string_setvalue(&tmpOVCarrierId.IdSpec, getCoreDataRsp->pvsl[i].pvs[j].carrierId.idSpec.data);
								tmpOVCarrierId.IdType = getCoreDataRsp->pvsl[i].pvs[j].carrierId.idType;
								tmpOVMask |= 0x01;
							}

							ExpressionLogicEnum tmpOVExpressionLogic = getCoreDataRsp->pvsl[i].pvs[j].expressionLogic;
							if (getCoreDataRsp->pvsl[i].pvs[j].expressionLogic != SRV_EL_undefined){
								tmpOVMask |= 0x02;
							}

							ExpressionSemanticEnum tmpOVExpressionSemantic = getCoreDataRsp->pvsl[i].pvs[j].expressionSemantic;
							if (getCoreDataRsp->pvsl[i].pvs[j].expressionSemantic != SRV_ES_undefined){
								tmpOVMask |= 0x04;
							}

							IdentificationType tmpOVPropertyId;
							IdentificationType_init(&tmpOVPropertyId);
							if (getCoreDataRsp->pvsl[i].pvs[j].propertyId.idType != SRV_IDT_undefined){
								ov_string_setvalue(&tmpOVPropertyId.IdSpec, getCoreDataRsp->pvsl[i].pvs[j].propertyId.idSpec.data);
								tmpOVPropertyId.IdType = getCoreDataRsp->pvsl[i].pvs[j].propertyId.idType;
								tmpOVMask |= 0x08;
							}

							ViewEnum tmpOVView = getCoreDataRsp->pvsl[i].pvs[j].view;
							if (getCoreDataRsp->pvsl[i].pvs[j].view != SRV_VIEW_undefined){
								tmpOVMask |= 0x10;
							}

							VisibilityEnum tmpOVVisibility = getCoreDataRsp->pvsl[i].pvs[j].visibility;
							if (getCoreDataRsp->pvsl[i].pvs[j].visibility != SRV_VIS_undefined){
								tmpOVMask |= 0x20;
							}

							OV_ANY tmpOVValue;
							tmpOVValue.value.vartype = OV_VT_VOID;
							serviceValueToOVDataValue(&tmpOVValue, &getCoreDataRsp->pvsl[i].pvs[j].value);

							result = openaas_modelmanager_createPVS(aasId, tmpOVPVSListId, tmpOVPvsName, tmpOVValue, tmpOVMask, tmpOVCarrierId,tmpOVExpressionLogic, tmpOVExpressionSemantic, tmpOVPropertyId, tmpOVView, tmpOVVisibility);

							IdentificationType_deleteMembers(&tmpOVPVSListId);
							ov_string_setvalue(&tmpOVPvsName, NULL);
							IdentificationType_deleteMembers(&tmpOVCarrierId);
							IdentificationType_deleteMembers(&tmpOVPropertyId);
							Ov_SetAnyValue(&tmpOVValue, NULL);
						}
						IdentificationType_deleteMembers(&tmpOVParentId);
						ov_string_setvalue(&tmpOVPvslName, NULL);
						IdentificationType_deleteMembers(&tmpOVCarrierId);
						IdentificationType_deleteMembers(&tmpOVPropertyId);
					}
				}
			}break;
			default:
				break;
			}
		}else{ // MSG is for another AAS => forward the message
			// Copy Message into Outbox
			resultOV = Ov_CreateObject(MessageSys_Message, answerMessage, &pinst->p_OUTBOX, message->v_identifier);
			if(Ov_Fail(resultOV)){
				SRV_serviceGeneric_delete(srvStructReceive, srvTypeReceive);
				SRV_msgHeader_t_delete(headerReceive);
				SRV_msgHeader_t_delete(headerSend);
				SRV_String_delete(srvStringReceive);
				SRV_String_delete(srvStringSend);
				IdentificationType_deleteMembers(&aasId);
				IdentificationType_deleteMembers(&receiver);
				Ov_DeleteObject((OV_INSTPTR_ov_object) message);
				ov_logfile_error("Could not copy message in outbox. Reason: %s", ov_result_getresulttext(resultOV));
				return;
			}
			MessageSys_Message_receiverAddress_set(answerMessage, message->v_receiverAddress);
			MessageSys_Message_receiverName_set(answerMessage, message->v_receiverName);
			MessageSys_Message_receiverComponent_set(answerMessage, message->v_receiverComponent);
			MessageSys_Message_senderAddress_set(answerMessage, message->v_senderAddress);
			MessageSys_Message_senderName_set(answerMessage, message->v_senderName);
			MessageSys_Message_senderComponent_set(answerMessage, message->v_senderComponent);
			MessageSys_Message_msgID_set(answerMessage, message->v_msgID);
			MessageSys_Message_msgStatus_set(answerMessage, message->v_msgStatus);
			MessageSys_Message_msgBody_set(answerMessage, message->v_msgBody);
			ov_string_setvalue(&answerMessage->v_auth, message->v_auth);
			answerMessage->v_expectAnswer = message->v_expectAnswer;
			ov_string_setvalue(&answerMessage->v_refMsgID, message->v_refMsgID);
			answerMessage->v_sendBy = message->v_sendBy;
			pinst->v_MsgIdForMessageForwarded = MessageSys_Message_msgID_get(answerMessage);
			answerMessage->v_msgStatus = MSGWAITING;

			ov_string_setvalue(&pinst->v_receiverForMessageForwardedIdString, receiver.IdSpec);
			pinst->v_receiverForMessageForwardedIdType = receiver.IdType;

			// Process the Message
			IdentificationType sender;
			IdentificationType_init(&sender);
			ov_string_setvalue(&sender.IdSpec, headerReceive->sender.idSpec.data);
			sender.IdType = headerReceive->sender.idType;
			ov_string_setvalue(&pinst->v_senderForMessageForwardedIdString, sender.IdSpec);
			pinst->v_senderForMessageForwardedIdType = sender.IdType;

			OV_STRING requestId = NULL;
			requestId = sendingRequestToDiscoveryServer(pinst, 2, &sender);
			IdentificationType_deleteMembers(&sender);
			if (requestId){
				ov_string_setvalue(&pinst->v_MsgIdForGetAASIdRequest, requestId);
			}
			pinst->v_messageCount = 0;
			pinst->v_state = 4;
		}

		if (sendAnswer == TRUE){
			// Create MessageObject in Outbox
			ov_string_setvalue(&tempString, NULL);
			ov_string_setvalue(&tempString, "answerMessageTo");
			ov_string_append(&tempString, message->v_identifier);
			resultOV = Ov_CreateObject(MessageSys_Message, answerMessage, &pinst->p_OUTBOX, tempString);
			ov_string_setvalue(&tempString, NULL);
			if(Ov_Fail(resultOV)){
				SRV_serviceGeneric_delete(srvStructReceive, srvTypeReceive);
				SRV_msgHeader_t_delete(headerReceive);
				SRV_msgHeader_t_delete(headerSend);
				SRV_String_delete(srvStringReceive);
				SRV_String_delete(srvStringSend);
				IdentificationType_deleteMembers(&aasId);
				IdentificationType_deleteMembers(&receiver);
				Ov_DeleteObject((OV_INSTPTR_ov_object) message);
				ov_logfile_error("Could not create an answerMessage. Reason: %s", ov_result_getresulttext(resultOV));
				return;
			}

			// Sender = Receiver of old message
			MessageSys_Message_senderAddress_set(answerMessage, message->v_receiverAddress);
			MessageSys_Message_senderName_set(answerMessage, message->v_receiverName);
			MessageSys_Message_senderComponent_set(answerMessage, message->v_receiverComponent);

			// Receiver = Sender of old message
			MessageSys_Message_receiverAddress_set(answerMessage, message->v_senderAddress);
			MessageSys_Message_receiverName_set(answerMessage, message->v_senderName);
			MessageSys_Message_receiverComponent_set(answerMessage, message->v_senderComponent);

			// reference Msg
			ov_string_setvalue(&answerMessage->v_refMsgID, message->v_msgID);

			// Body
			// XML Encoding
			OV_STRING answerBody = NULL;
			ov_string_setvalue(&answerBody, "<bdy>");
			ov_string_append(&answerBody, srvStringSend->data);
			ov_string_append(&answerBody, "</bdy>");
			ov_string_setvalue(&answerMessage->v_msgBody, answerBody);
			ov_string_setvalue(&answerBody, NULL);

			// Message ready for sending
			answerMessage->v_msgStatus = MSGREADYFORSENDING;

			// Search for MsgDelivery object
			Ov_ForEachChildEx(ov_instantiation, pclass_MessageSys_MsgDelivery, pmsgDelivery, MessageSys_MsgDelivery){
				if(ov_string_compare(pmsgDelivery->v_identifier, "MessageSys") == OV_STRCMP_EQUAL){
					break;
				}
			}
			if (!pmsgDelivery){
				SRV_serviceGeneric_delete(srvStructReceive, srvTypeReceive);
				SRV_msgHeader_t_delete(headerReceive);
				SRV_msgHeader_t_delete(headerSend);
				SRV_String_delete(srvStringReceive);
				SRV_String_delete(srvStringSend);
				IdentificationType_deleteMembers(&aasId);
				IdentificationType_deleteMembers(&receiver);
				Ov_DeleteObject((OV_INSTPTR_ov_object) message);
				Ov_DeleteObject((OV_INSTPTR_ov_object) answerMessage);
				ov_logfile_error("Could not find MessageSys");
				return;
			}

			// send Message
			if (MessageSys_MsgDelivery_sendMessage(pmsgDelivery, answerMessage) == FALSE){
				SRV_serviceGeneric_delete(srvStructReceive, srvTypeReceive);
				SRV_msgHeader_t_delete(headerReceive);
				SRV_msgHeader_t_delete(headerSend);
				SRV_String_delete(srvStringReceive);
				SRV_String_delete(srvStringSend);
				IdentificationType_deleteMembers(&aasId);
				IdentificationType_deleteMembers(&receiver);
				Ov_DeleteObject((OV_INSTPTR_ov_object) message);
				Ov_DeleteObject((OV_INSTPTR_ov_object) answerMessage);
				ov_logfile_error("Could not send Message");
				return;
			}
		}

		// delete all used memory
		SRV_serviceGeneric_delete(srvStructReceive, srvTypeReceive);
		SRV_msgHeader_t_delete(headerReceive);
		SRV_msgHeader_t_delete(headerSend);
		SRV_String_delete(srvStringReceive);
		SRV_String_delete(srvStringSend);
		IdentificationType_deleteMembers(&aasId);
		IdentificationType_deleteMembers(&receiver);
		Ov_DeleteObject((OV_INSTPTR_ov_object) message);
		break;
	case 4: // Forward Message Getting the sender
		// Get the next message, if any.
		pinst->v_messageCount++;
		pTaskParent=Ov_GetParent(fb_tasklist, pinst);
		tmpTimeSpan.usecs = pTaskParent->v_cyctime.usecs * pinst->v_messageCount;
		tmpTimeSpan.secs = pTaskParent->v_cyctime.secs * pinst->v_messageCount;
		if((OV_INT)tmpTimeSpan.usecs > 999999) {
			tmpTimeSpan.usecs -= 1000000;
			tmpTimeSpan.secs++;
			return;
		}
		if (tmpTimeSpan.secs > pinst->v_messageTimeOut.secs || (tmpTimeSpan.secs == pinst->v_messageTimeOut.secs && tmpTimeSpan.usecs > pinst->v_messageTimeOut.usecs)){
			pinst->v_messageCount = 0;
			IdentificationType tmpAAS;
			tmpAAS.IdSpec = NULL;
			ov_string_setvalue(&tmpAAS.IdSpec, pinst->v_receiverForMessageForwardedIdString);
			tmpAAS.IdType = pinst->v_receiverForMessageForwardedIdType;
			OV_STRING requestId = NULL;
			requestId = sendingRequestToDiscoveryServer(pinst, 2, &tmpAAS);
			if (requestId){
				ov_string_setvalue(&pinst->v_MsgIdForGetAASIdRequest, requestId);
			}
		}
		// Find Message with GetAAS-Response
		pchild = NULL;
		pchild = Ov_GetLastChild(ov_containment, &pinst->p_INBOX);
		while (true){
			while (pchild && !Ov_CanCastTo(MessageSys_Message , pchild)) {
				pchild = Ov_GetPreviousChild(ov_containment, pchild);
			}
			if (pchild == NULL){
				break;
			}

			message = Ov_StaticPtrCast(MessageSys_Message, pchild);

			if (ov_string_compare(message->v_refMsgID, pinst->v_MsgIdForGetAASIdRequest) == OV_STRCMP_EQUAL){
				// Decoding the Message
				// XML Decoding
				if (strncmp(message->v_msgBody, "<bdy>", 5) != 0){ // <bdy> not found
					Ov_DeleteObject((OV_INSTPTR_ov_object) message);
					ov_logfile_info("AASComponentManager: <bdy> not found in msg. Reason");
					return;
				}
				messageLength = ov_string_getlength(message->v_msgBody);
				if (strncmp(&message->v_msgBody[messageLength-6], "</bdy>", 6) != 0){ // </bdy> not found
					Ov_DeleteObject((OV_INSTPTR_ov_object) message);
					ov_logfile_info("AASComponentManager: </bdy> not found in msg. Reason");
					return;
				}
				messageContent = malloc((messageLength-11+1)*sizeof(char));
				memcpy(messageContent, (message->v_msgBody+5), messageLength-11);
				messageContent[messageLength-11] = '\0';

				plistReq= ov_string_split(messageContent, ":", &len);
				OV_STRING *plistParameter = NULL;
				OV_UINT len2 = 0;
				plistParameter= ov_string_split(messageContent+ov_string_getlength(plistReq[0])+1, ",", &len2);
				free(messageContent);
				if (ov_string_compare(plistReq[0], "GetAASRes") == OV_STRCMP_EQUAL){
					if (ov_string_compare(plistParameter[0], "OK") == OV_STRCMP_EQUAL){ // get was successfully
						// TODO: Check ParameterType
						if (len2 == 4){
							pchild = Ov_GetLastChild(ov_containment, &pinst->p_OUTBOX);
							while (true){
								while (pchild && !Ov_CanCastTo(MessageSys_Message , pchild)) {
									pchild = Ov_GetPreviousChild(ov_containment, pchild);
								}
								if (pchild == NULL){
									pinst->v_state = 6;
									break;
								}
								answerMessage = Ov_StaticPtrCast(MessageSys_Message, pchild);
								if (ov_string_compare(answerMessage->v_msgID, pinst->v_MsgIdForMessageForwarded) == OV_STRCMP_EQUAL){
									break;
								}
								pchild = Ov_GetPreviousChild(ov_containment, pchild);
							}
							MessageSys_Message_senderAddress_set(answerMessage, plistParameter[1]);
							MessageSys_Message_senderName_set(answerMessage, plistParameter[2]);
							MessageSys_Message_senderComponent_set(answerMessage, plistParameter[3]);

							OV_STRING requestId = NULL;
							IdentificationType receiver;
							IdentificationType_init(&receiver);
							ov_string_setvalue(&receiver.IdSpec, pinst->v_receiverForMessageForwardedIdString);
							receiver.IdType = pinst->v_receiverForMessageForwardedIdType;

							requestId = sendingRequestToDiscoveryServer(pinst, 2, &receiver);
							if (requestId){
								ov_string_setvalue(&pinst->v_MsgIdForGetAASIdRequest, requestId);
							}
							IdentificationType_deleteMembers(&receiver);
							pinst->v_messageCount = 0;
							pinst->v_state = 5;
						}else{
							ov_logfile_info("GetAASRes: Incorrect size of parameters");
							pinst->v_state = 5;
						}
					}else{
						ov_logfile_info("GetAASRes: Failed");
						pinst->v_state = 5;
					}
				}else{
					ov_logfile_info("Incorrect Message to GetAASReq");
					pinst->v_state = 5;
				}
				Ov_DeleteObject((OV_INSTPTR_ov_object) message);
				ov_string_freelist(plistReq);
				break;
			}
			pchild = Ov_GetPreviousChild(ov_containment, pchild);
		}
		break;
	case 5: // Forward Message Getting the receiver
		// Get the next message, if any.
		pinst->v_messageCount++;
		pTaskParent=Ov_GetParent(fb_tasklist, pinst);
		tmpTimeSpan.usecs = pTaskParent->v_cyctime.usecs * pinst->v_messageCount;
		tmpTimeSpan.secs = pTaskParent->v_cyctime.secs * pinst->v_messageCount;
		if((OV_INT)tmpTimeSpan.usecs > 999999) {
			tmpTimeSpan.usecs -= 1000000;
			tmpTimeSpan.secs++;
			return;
		}
		if (tmpTimeSpan.secs > pinst->v_messageTimeOut.secs || (tmpTimeSpan.secs == pinst->v_messageTimeOut.secs && tmpTimeSpan.usecs > pinst->v_messageTimeOut.usecs)){
			pinst->v_messageCount = 0;
			IdentificationType tmpAAS;
			tmpAAS.IdSpec = NULL;
			ov_string_setvalue(&tmpAAS.IdSpec, pinst->v_receiverForMessageForwardedIdString);
			tmpAAS.IdType = pinst->v_receiverForMessageForwardedIdType;
			OV_STRING requestId = NULL;
			requestId = sendingRequestToDiscoveryServer(pinst, 2, &tmpAAS);
			if (requestId){
				ov_string_setvalue(&pinst->v_MsgIdForGetAASIdRequest, requestId);
			}
		}
		// Find Message with GetAAS-Response
		pchild = NULL;
		pchild = Ov_GetLastChild(ov_containment, &pinst->p_INBOX);
		while (true){
			while (pchild && !Ov_CanCastTo(MessageSys_Message , pchild)) {
				pchild = Ov_GetPreviousChild(ov_containment, pchild);
			}
			if (pchild == NULL){
				break;
			}

			message = Ov_StaticPtrCast(MessageSys_Message, pchild);

			if (ov_string_compare(message->v_refMsgID, pinst->v_MsgIdForGetAASIdRequest) == OV_STRCMP_EQUAL){
				// Decoding the Message
				// XML Decoding
				if (strncmp(message->v_msgBody, "<bdy>", 5) != 0){ // <bdy> not found
					Ov_DeleteObject((OV_INSTPTR_ov_object) message);
					ov_logfile_info("AASComponentManager: <bdy> not found in msg. Reason");
					return;
				}
				messageLength = ov_string_getlength(message->v_msgBody);
				if (strncmp(&message->v_msgBody[messageLength-6], "</bdy>", 6) != 0){ // </bdy> not found
					Ov_DeleteObject((OV_INSTPTR_ov_object) message);
					ov_logfile_info("AASComponentManager: </bdy> not found in msg. Reason");
					return;
				}
				messageContent = malloc((messageLength-11+1)*sizeof(char));
				memcpy(messageContent, (message->v_msgBody+5), messageLength-11);
				messageContent[messageLength-11] = '\0';

				plistReq= ov_string_split(messageContent, ":", &len);
				OV_STRING *plistParameter = NULL;
				OV_UINT len2 = 0;
				plistParameter= ov_string_split(messageContent+ov_string_getlength(plistReq[0])+1, ",", &len2);
				free(messageContent);
				if (ov_string_compare(plistReq[0], "GetAASRes") == OV_STRCMP_EQUAL){
					if (ov_string_compare(plistParameter[0], "OK") == OV_STRCMP_EQUAL){ // get was successfully
						// TODO: Check ParameterType
						if (len2 == 4){
							pchild = Ov_GetLastChild(ov_containment, &pinst->p_OUTBOX);
							while (true){
								while (pchild && !Ov_CanCastTo(MessageSys_Message , pchild)) {
									pchild = Ov_GetPreviousChild(ov_containment, pchild);
								}
								if (pchild == NULL){
									pinst->v_state = 8;
									break;
								}
								answerMessage = Ov_StaticPtrCast(MessageSys_Message, pchild);
								if (ov_string_compare(answerMessage->v_msgID, pinst->v_MsgIdForMessageForwarded) == OV_STRCMP_EQUAL){
									break;
								}
								pchild = Ov_GetPreviousChild(ov_containment, pchild);
							}
							MessageSys_Message_receiverAddress_set(answerMessage, plistParameter[1]);
							MessageSys_Message_receiverName_set(answerMessage, plistParameter[2]);
							MessageSys_Message_receiverComponent_set(answerMessage, plistParameter[3]);

							// Message ready for sending
							answerMessage->v_msgStatus = MSGREADYFORSENDING;

							// Search for MsgDelivery object
							Ov_ForEachChildEx(ov_instantiation, pclass_MessageSys_MsgDelivery, pmsgDelivery, MessageSys_MsgDelivery){
								if(ov_string_compare(pmsgDelivery->v_identifier, "MessageSys") == OV_STRCMP_EQUAL){
									break;
								}
							}
							if (!pmsgDelivery){
								Ov_DeleteObject((OV_INSTPTR_ov_object) message);
								Ov_DeleteObject((OV_INSTPTR_ov_object) answerMessage);
								ov_logfile_error("Could not find MessageSys");
								return;
							}

							// send Message
							if (MessageSys_MsgDelivery_sendMessage(pmsgDelivery, answerMessage) == FALSE){
								Ov_DeleteObject((OV_INSTPTR_ov_object) message);
								Ov_DeleteObject((OV_INSTPTR_ov_object) answerMessage);
								ov_logfile_error("Could not send Message");
								return;
							}

							pTaskParent=Ov_GetParent(fb_tasklist, pinst);
							if(pTaskParent->v_cyctime.secs > 0)
								pinst->v_messageCount = pinst->v_messageTimeOut.secs / pTaskParent->v_cyctime.secs;
							else
								pinst->v_messageCount = pinst->v_messageTimeOut.usecs / pTaskParent->v_cyctime.usecs;
							pinst->v_state = 3;
						}else{
							ov_logfile_info("GetAASRes: Incorrect size of parameters");
							pinst->v_state = 8;
						}
					}else{
						ov_logfile_info("GetAASRes: Failed");
						pinst->v_state = 3;
					}
				}else{
					ov_logfile_info("Incorrect Message to GetAASReq");
					pinst->v_state = 8;
				}
				Ov_DeleteObject((OV_INSTPTR_ov_object) message);
				ov_string_freelist(plistReq);
				break;
			}
			pchild = Ov_GetPreviousChild(ov_containment, pchild);
		}
		break;
	case 6: //Sending Unregister-Request and wait for answer
		// Get the next message, if any.
		Ov_ForEachChildEx(ov_containment, &pinst->p_OUTBOX, message, MessageSys_Message){
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
		}
		if (pinst->v_registered == TRUE){
			sendingRequestToDiscoveryServer(pinst, 3, NULL);
		}
		pinst->v_state = 7;
		break;
	case 7: //Ready for delete or reset
		pinst->v_state = 0;
		Ov_ForEachChildEx(ov_containment, &pinst->p_OUTBOX, message, MessageSys_Message){
			pinst->v_state = 7;
			break;
		}
		break;
	case 8: // Error, wait for reset
		break;
	default:
		break;
	}
	return;
}


OV_DLLFNCEXPORT AASStatusCode openaas_AASComponentManager_sendMessage(OV_INSTPTR_openaas_AASComponentManager this,IdentificationType senderAASId, IdentificationType receiverAASId, OV_UINT msgNo, SRV_service_t serviceType, void* srvStruct) {
	OV_STRING tempString = NULL;
	OV_INSTPTR_MessageSys_Message message = NULL;
	OV_RESULT resultOV = 0;
	OV_UINT ID = 4294967295;

	// Create MessageObject in Inbox
	srand ( time(NULL) );
	LOCALMSGCOUNTER = LOCALMSGCOUNTER + 1;
	while(ID>=4294967295){
		ID = (((rand() % 1625)+1) * ((rand() % 1625)+1) * ((rand() % 1625)+1)) + LOCALMSGCOUNTER;
	}
	ov_string_print(&tempString, "%lu", ID);
	resultOV = Ov_CreateObject(MessageSys_Message, message, &this->p_INBOX, tempString);
	ov_string_setvalue(&tempString, NULL);
	if(Ov_Fail(resultOV)){
		ov_logfile_error("Could not create an Message. Reason: %s", ov_result_getresulttext(resultOV));
		return AASSTATUSCODE_BADUNEXPECTEDERROR;
	}

	// Sender unknown
	MessageSys_Message_senderAddress_set(message, NULL);
	MessageSys_Message_senderName_set(message,NULL);
	MessageSys_Message_senderComponent_set(message, NULL);

	// Receiver unknown
	MessageSys_Message_receiverAddress_set(message, NULL);
	MessageSys_Message_receiverName_set(message, NULL);
	MessageSys_Message_receiverComponent_set(message, NULL);

	// reference Msg
	ov_string_setvalue(&message->v_refMsgID, NULL);

	// Body
	// For encoding the message
	SRV_String *srvStringSend = NULL;
	SRV_msgHeader *headerSend = SRV_msgHeader_t_new();
	headerSend->msgNo = msgNo;
	SRV_String_setCopy(&headerSend->sender.idSpec, senderAASId.IdSpec, ov_string_getlength(senderAASId.IdSpec));
	headerSend->sender.idType = senderAASId.IdType;
	SRV_String_setCopy(&headerSend->receiver.idSpec, receiverAASId.IdSpec, ov_string_getlength(receiverAASId.IdSpec));
	headerSend->receiver.idType = receiverAASId.IdType;

	resultOV = encodeMSG(&srvStringSend, headerSend, srvStruct, serviceType, SRV_JSON);
	// XML Encoding
	OV_STRING answerBody = NULL;
	ov_string_setvalue(&answerBody, "<bdy>");
	ov_string_append(&answerBody, srvStringSend->data);
	ov_string_append(&answerBody, "</bdy>");
	ov_string_setvalue(&message->v_msgBody, answerBody);
	ov_string_setvalue(&answerBody, NULL);
	SRV_msgHeader_t_delete(headerSend);
	SRV_String_delete(srvStringSend);

	// Message ready for sending
	message->v_msgStatus = MSGDONE;

    return (AASStatusCode)0;
}

OV_DLLFNCEXPORT void openaas_AASComponentManager_destructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*
    *   local variables
    */
    OV_INSTPTR_openaas_AASComponentManager pinst = Ov_StaticPtrCast(openaas_AASComponentManager, pobj);

    /* do what */
    if (pinst->v_state == 3 || pinst->v_state == 4 || pinst->v_state == 5)
    	sendingRequestToDiscoveryServer(pinst, 3, NULL);

    /* destroy object */
    fb_functionblock_destructor(pobj);


    return;
}
