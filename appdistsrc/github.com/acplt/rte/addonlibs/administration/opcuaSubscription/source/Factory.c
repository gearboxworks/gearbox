
/******************************************************************************
 *
 *   FILE
 *   ----
 *   Factory.c
 *
 *   History
 *   -------
 *   2018-01-23   File created
 *
 *******************************************************************************
 *
 *   This file is generated by the 'acplt_builder' command
 *
 ******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_opcuaSubscription
#define OV_COMPILE_LIBRARY_opcuaSubscription
#endif


#include "opcuaSubscription.h"
#include "libov/ov_macros.h"
#include "fb_database.h"

OV_STRING replace_char(OV_STRING str, char find, char replace){
	OV_STRING current_pos = strchr(str,find);
	while (current_pos){
		*current_pos = replace;
		current_pos = strchr(current_pos,find);
	}
	return str;
}

OV_DLLFNCEXPORT OV_RESULT opcuaSubscription_Factory_serverEndpointUrl_set(
		OV_INSTPTR_opcuaSubscription_Factory          pobj,
		const OV_STRING  value
) {
	return ov_string_setvalue(&pobj->v_serverEndpointUrl,value);
}

OV_DLLFNCEXPORT OV_RESULT opcuaSubscription_Factory_create_set(
		OV_INSTPTR_opcuaSubscription_Factory          pobj,
		const OV_BOOL  value
) {
	/* local variables */
	OV_INSTPTR_ov_domain pClientParent = NULL;
	OV_INSTPTR_opcuaSubscription_subscriptionClient pClient = NULL;
	OV_INSTPTR_opcuaSubscription_subscriptionSettings pSettings = NULL;
	OV_INSTPTR_opcuaSubscription_Variable pVariable = NULL;
	OV_STRING variableName = NULL;
	OV_STRING tmpVariableName = NULL;

	OV_INSTPTR_fb_task pUrtask = NULL;

	OV_RESULT result = OV_ERR_OK;

	if(!value){
		return OV_ERR_OK;
	}

	/* check string input */
	if(ov_string_compare(pobj->v_placement,"") == OV_STRCMP_EQUAL ||
			ov_string_compare(pobj->v_name,"") == OV_STRCMP_EQUAL ||
			ov_string_compare(pobj->v_serverEndpointUrl,"") == OV_STRCMP_EQUAL ){
		/* input missing */
		return OV_ERR_BADPARAM;
	}
	/* check vec inputs */
	/* compare length */
	if (((pobj->v_NodeIDIdType.veclen != pobj->v_NodeIDIdentifier.veclen)
			|| (pobj->v_NodeIDIdentifier.veclen
					!= pobj->v_NodeIDNSindex.veclen))
			|| pobj->v_NodeIDIdType.veclen == 0) {
		return OV_ERR_BADPARAM;
	}
	/* check for NULL entry*/
	OV_UINT index = 0;
	while (index < pobj->v_NodeIDIdentifier.veclen &&
			ov_string_compare(pobj->v_NodeIDIdentifier.value[index], "")!= OV_STRCMP_EQUAL) {
		index++;
	}
	if (index != pobj->v_NodeIDIdentifier.veclen) {
		return OV_ERR_BADPARAM;
	}

	/* check if placement is possible */
	ov_memstack_lock(); //TODO: check proper use of memstack_lock
	pClientParent = Ov_DynamicPtrCast(ov_domain,ov_path_getobjectpointer(pobj->v_placement,2));
	ov_memstack_unlock();
	if(!pClientParent){
		return OV_ERR_BADPARAM;
	}

	/* create subscriptionClient */
	result = Ov_CreateObject(opcuaSubscription_subscriptionClient,pClient,pClientParent,pobj->v_name);
	if(Ov_Fail(result)){
		return result;
	}

	/* add to task list */
	pUrtask = (OV_INSTPTR_fb_task)fb_database_geturtask();
	if (!pUrtask){
		return OV_ERR_GENERIC;
	}
	Ov_Link(fb_tasklist, pUrtask, pClient);

	/* set serverEndpointUrl */
	opcuaSubscription_subscriptionClient_serverEndpointUrl_set(pClient, pobj->v_serverEndpointUrl);

	/* create variable Children */
	for(OV_UINT ItemIterator = 0; ItemIterator < pobj->v_NodeIDIdentifier.veclen; ItemIterator++){
		/* create variable object as a child of this instance and link it */
		switch (pobj->v_NodeIDIdType.value[ItemIterator]){
		case (UA_IDTYPE_STRING) : {
			if(strchr(pobj->v_NodeIDIdentifier.value[ItemIterator],'/')){
				result = ov_string_setvalue(&tmpVariableName,pobj->v_NodeIDIdentifier.value[ItemIterator]);
				result = ov_string_setvalue(&variableName,replace_char(strrchr(tmpVariableName,'/')+1, '.', '_'));
				result = ov_string_setvalue(&tmpVariableName,"");
				if(Ov_Fail(result)){
					return result;
				}
			} else {
				result = ov_string_setvalue(&variableName,pobj->v_NodeIDIdentifier.value[ItemIterator]);
				replace_char(variableName, '.', '_');
				if(Ov_Fail(result)){
					return result;
				}
			}
			break;
		}
		case (UA_IDTYPE_NUMERIC) : {
			result = ov_string_print(&variableName,"%i-%s",pobj->v_NodeIDNSindex.value[ItemIterator],pobj->v_NodeIDIdentifier.value[ItemIterator]);
			if(Ov_Fail(result)){
				return result;
			}
			break;
		}
		case (UA_IDTYPE_OPAQUE) : {
			return OV_ERR_NOTIMPLEMENTED;
		}
		case (UA_IDTYPE_GUID) : {
			return OV_ERR_NOTIMPLEMENTED;
		}
		default:
			return OV_ERR_BADPARAM;
		}
		result = Ov_CreateObject(opcuaSubscription_Variable,pVariable,Ov_DynamicPtrCast(ov_domain,pClient),variableName);
		if(Ov_Fail(result)){
			return result;
		}
		result = Ov_Link(fb_tasklist, pClient, pVariable);
		if(Ov_Fail(result)){
			return result;
		}
		result = Ov_Link(opcuaSubscription_subscriptionResult,pClient,pVariable);
		if(Ov_Fail(result)){
			return result;
		}
		result = opcuaSubscription_Variable_order_set(pVariable,ItemIterator);
		if(Ov_Fail(result)){
			return result;
		}
		result = opcuaSubscription_Variable_NodeIDIdentifier_set(pVariable,pobj->v_NodeIDIdentifier.value[ItemIterator]);
		if(Ov_Fail(result)){
			return result;
		}
		result = opcuaSubscription_Variable_NodeIDIdType_set(pVariable,pobj->v_NodeIDIdType.value[ItemIterator]);
		if(Ov_Fail(result)){
			return result;
		}
		result = opcuaSubscription_Variable_NodeIDNSindex_set(pVariable,pobj->v_NodeIDNSindex.value[ItemIterator]);
		if(Ov_Fail(result)){
			return result;
		}
		result = ov_string_setvalue(&variableName,"");
		if(Ov_Fail(result)){
			return result;
		}
	}

	/* create Settings object */
	result = Ov_CreateObject(opcuaSubscription_subscriptionSettings,pSettings,Ov_DynamicPtrCast(ov_domain,pClient),"subscriptionSettings");
	if(Ov_Fail(result)){
		return result;
	}
	result = Ov_Link(opcuaSubscription_settings,pSettings,pClient);
	if(Ov_Fail(result)){
		return result;
	}

	return result;
}

OV_DLLFNCEXPORT OV_ACCESS opcuaSubscription_Factory_getaccess(
		OV_INSTPTR_ov_object	pobj,
		const OV_ELEMENT		*pelem,
		const OV_TICKET			*pticket
) {
	/*
	 *   local variables
	 */


	switch(pelem->elemtype) {
		case OV_ET_VARIABLE:
			if(pelem->elemunion.pvar->v_offset >= offsetof(OV_INST_ov_object,__classinfo)) {
				if(pelem->elemunion.pvar->v_vartype == OV_VT_CTYPE)
					return OV_AC_NONE;
				else{
					if((pelem->elemunion.pvar->v_varprops & OV_VP_DERIVED)){
						if((pelem->elemunion.pvar->v_varprops & OV_VP_SETACCESSOR)){
							return OV_AC_READWRITE;
						} else {
							return OV_AC_READ;
						}
					} else {
						return OV_AC_READWRITE;
					}
				}
			}
		break;
		default:
		break;
	}

	return ov_object_getaccess(pobj, pelem, pticket);
}

