/******************************************************************************
*
*   FILE
*   ----
*   HMIHelperLCEList.c
*
*   History
*   -------
*   2017-03-08   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_subModelLifeCycleEntry
#define OV_COMPILE_LIBRARY_subModelLifeCycleEntry
#endif


#include "libov/ov_macros.h"
#include "libov/ov_time.h"
#include "subModelLifeCycleEntry.h"


OV_DLLFNCEXPORT void subModelLifeCycleEntry_HMIHelperLCEList_typemethod(
	OV_INSTPTR_fb_functionblock	pfb,
	OV_TIME						*pltc
) {
    /*    

    *   local variables
    */

	OV_INSTPTR_subModelLifeCycleEntry_HMIHelperLCEList pinst = Ov_StaticPtrCast(subModelLifeCycleEntry_HMIHelperLCEList, pfb);
	OV_INSTPTR_ov_object pobj = NULL;
	OV_INSTPTR_lifeCycleEntry_LifeCycleEntry pchild = NULL;
	OV_INSTPTR_lifeCycleEntry_LifeCycleArchive pArchive = NULL;
	OV_INSTPTR_subModelLifeCycleEntry_SubModelLifeCycleEntry pSubModel = NULL;
	OV_INSTPTR_openaas_aas paas = NULL;


	ov_string_setvalue(&pinst->v_CreatingInstanceId, "");
	ov_string_setvalue(&pinst->v_Data, "");
	ov_string_setvalue(&pinst->v_EventClass, "");
	ov_string_setvalue(&pinst->v_Id, "");
	ov_string_setvalue(&pinst->v_Subject, "");
	ov_string_setvalue(&pinst->v_TimeStamp, "");
	ov_string_setvalue(&pinst->v_WritingInstanceId, "");
	pinst->v_Error = FALSE;
	ov_string_setvalue(&pinst->v_ErrorText, "");

	OV_UINT len = 0;
	OV_STRING *pathList = NULL;
	OV_STRING path = NULL;
	pathList = ov_string_split(pinst->v_AASPath, "/", &len);


	for (OV_UINT i = 4; i < len; i++){
		if (i == 4)
			ov_string_setvalue(&path, "/");
		else
			ov_string_append(&path, "/");
		ov_string_append(&path, pathList[i]);
	}
	ov_string_freelist(pathList);
	pobj = ov_path_getobjectpointer(path,2);
	if (!pobj){
		pinst->v_Error = TRUE;
		ov_string_setvalue(&pinst->v_ErrorText, "Could not find an object for this path");
		ov_string_setvalue(&path, NULL);
		return;
	}

	paas = Ov_DynamicPtrCast(openaas_aas, pobj);
	if (!paas){
		pinst->v_Error = TRUE;
		ov_string_setvalue(&pinst->v_ErrorText, "Object is not of aas-Type");
		ov_string_setvalue(&path, NULL);
		return;
	}

	OV_STRING tmpString = NULL;
	OV_UINT i = 0;
	// Search LCE Archive
	Ov_ForEachChildEx(ov_containment, &paas->p_Body, pSubModel, subModelLifeCycleEntry_SubModelLifeCycleEntry){
		pArchive = Ov_DynamicPtrCast(lifeCycleEntry_LifeCycleArchive, &pSubModel->p_LifeCycleArchiv);
	}

	if (!pArchive){
		pinst->v_Error = TRUE;
		ov_string_setvalue(&pinst->v_ErrorText, "Could not find the LCE Archive in the AAS");
		return;
	}

	OV_BOOL findLCE = FALSE;
	Ov_ForEachChildEx(ov_containment, pArchive, pchild, lifeCycleEntry_LifeCycleEntry){
		findLCE = TRUE;
		if (i != 0){
			ov_string_append(&pinst->v_CreatingInstanceId, ";");
			ov_string_append(&pinst->v_Data, ";");
			ov_string_append(&pinst->v_EventClass, ";");
			ov_string_append(&pinst->v_Id, ";");
			ov_string_append(&pinst->v_Subject, ";");
			ov_string_append(&pinst->v_TimeStamp, ";");
			ov_string_append(&pinst->v_WritingInstanceId, ";");
		}

		switch (pchild->v_CreatingInstanceIdType){
			case URI:
				if (i == 0)
					ov_string_setvalue(&pinst->v_CreatingInstanceId, "URI:");
				else
					ov_string_append(&pinst->v_CreatingInstanceId, "URI:");
			break;
			case ISO:
				if (i == 0)
					ov_string_setvalue(&pinst->v_CreatingInstanceId, "ISO:");
				else
					ov_string_append(&pinst->v_CreatingInstanceId, "ISO:");
			break;
		}

		ov_string_append(&pinst->v_CreatingInstanceId, pchild->v_CreatingInstanceIdString);

		if (i == 0)
			ov_string_setvalue(&pinst->v_EventClass, pchild->v_EventClass);
		else
			ov_string_append(&pinst->v_EventClass, pchild->v_EventClass);

		if (i == 0)
			ov_string_setvalue(&pinst->v_Id, pchild->v_identifier);
		else
			ov_string_append(&pinst->v_Id, pchild->v_identifier);

		if (i == 0)
			ov_string_setvalue(&pinst->v_Subject, pchild->v_Subject);
		else
			ov_string_append(&pinst->v_Subject, pchild->v_Subject);

		if (i == 0)
			ov_string_setvalue(&pinst->v_TimeStamp, ov_time_timetoascii_local(&pchild->v_TimeStamp));
		else
			ov_string_append(&pinst->v_TimeStamp, ov_time_timetoascii_local(&pchild->v_TimeStamp));

		switch (pchild->v_WritingInstanceIdType){
			case URI:
				if (i == 0)
					ov_string_setvalue(&pinst->v_WritingInstanceId, "URI:");
				else
					ov_string_append(&pinst->v_WritingInstanceId, "URI:");
			break;
			case ISO:
				if (i == 0)
					ov_string_setvalue(&pinst->v_WritingInstanceId, "ISO:");
				else
					ov_string_append(&pinst->v_WritingInstanceId, "ISO:");
			break;
		}
		ov_string_append(&pinst->v_WritingInstanceId, pchild->v_WritingInstanceIdString);

		if(!(pchild->v_Data.value.vartype & OV_VT_ISVECTOR)){
			switch(pchild->v_Data.value.vartype & OV_VT_KSMASK){
				case OV_VT_BOOL:
					if (pchild->v_Data.value.valueunion.val_bool == TRUE)
						if (i == 0)
							ov_string_setvalue(&pinst->v_Data, "TRUE");
						else
							ov_string_append(&pinst->v_Data, "TRUE");
					else
						if (i == 0)
							ov_string_setvalue(&pinst->v_Data, "FALSE");
						else
							ov_string_append(&pinst->v_Data, "FALSE");
				break;
				case OV_VT_STRING:
					if (i == 0)
						ov_string_setvalue(&pinst->v_Data, pchild->v_Data.value.valueunion.val_string);
					else
						ov_string_append(&pinst->v_Data, pchild->v_Data.value.valueunion.val_string);
				break;
				case OV_VT_DOUBLE:
					ov_string_print(&tmpString, "%lf", pchild->v_Data.value.valueunion.val_double);
					if (i == 0)
						ov_string_setvalue(&pinst->v_Data, tmpString);
					else
						ov_string_append(&pinst->v_Data, tmpString);
				break;
				case OV_VT_INT:
					ov_string_print(&tmpString, "%i", pchild->v_Data.value.valueunion.val_int);
					if (i == 0)
						ov_string_setvalue(&pinst->v_Data, tmpString);
					else
						ov_string_append(&pinst->v_Data, tmpString);
				break;
				case OV_VT_UINT:
					ov_string_print(&tmpString, "%u", pchild->v_Data.value.valueunion.val_uint);
					if (i == 0)
						ov_string_setvalue(&pinst->v_Data, tmpString);
					else
						ov_string_append(&pinst->v_Data, tmpString);
				break;
				case OV_VT_SINGLE:
					ov_string_print(&tmpString, "%f", pchild->v_Data.value.valueunion.val_single);
					if (i == 0)
						ov_string_setvalue(&pinst->v_Data, tmpString);
					else
						ov_string_append(&pinst->v_Data, tmpString);
				break;
				default:
					if (pinst->v_Error == FALSE){
						pinst->v_Error = TRUE;
						ov_string_setvalue(&pinst->v_ErrorText, "DataType not supported");
					}
				break;
			}
		}else{
			if (pinst->v_Error == FALSE){
				pinst->v_Error = TRUE;
				ov_string_setvalue(&pinst->v_ErrorText, "Arrays not supported");
			}
		}

	i++;
	}
	if (findLCE == FALSE){
		pinst->v_Error = TRUE;
		ov_string_setvalue(&pinst->v_ErrorText, "No LCE found");
	}

	ov_string_setvalue(&tmpString, NULL);
	ov_string_setvalue(&path, NULL);

    return;
}
